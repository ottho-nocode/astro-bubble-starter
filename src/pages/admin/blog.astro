---
export const prerender = false;

import Admin from "../../layouts/Admin.astro";
import { verifySession, getSessionFromRequest } from "../../lib/admin-auth";

const token = getSessionFromRequest(Astro.request);
if (!(await verifySession(token))) {
  return Astro.redirect("/admin/login");
}
---

<Admin title="Blog" activePage="blog">
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-dots">
      <span></span><span></span><span></span>
    </div>
  </div>

  <div class="blog-builder" id="blogBuilder">
    <!-- Panneau controles (gauche) -->
    <aside class="builder-controls" id="builderControls">
      <header class="builder-controls-header">
        <div>
          <h2>Blog</h2>
          <p>Configurateur visuel</p>
        </div>
        <button class="builder-close-btn" id="closeControls" aria-label="Fermer">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </header>

      <div class="builder-controls-body" id="controlsBody">
        <!-- Section 1: En-tete -->
        <div class="accordion-section" data-section="header">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h8"/><path d="M4 18V6"/><path d="M12 18V6"/><path d="M21 18h-2a2 2 0 01-2-2v-4a2 2 0 012-2h2"/></svg>
              En-tete
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-heroTitle">Titre</label>
              <input type="text" id="cfg-heroTitle" placeholder="Blog" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroSubtitle">Sous-titre</label>
              <textarea id="cfg-heroSubtitle" rows="2" placeholder="Decouvrez nos derniers articles..."></textarea>
            </div>
            <div class="ctrl-group">
              <label>Fond</label>
              <div class="hero-bg-grid" id="heroBgContainer"></div>
            </div>
          </div>
        </div>

        <!-- Section 2: Mise en page -->
        <div class="accordion-section" data-section="layout">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Mise en page
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="template-grid" id="templateContainer"></div>
          </div>
        </div>

        <!-- Section 3: Style visuel -->
        <div class="accordion-section" data-section="style">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17.5 10.5c.5.5 1 1.5 1 2.5a3.5 3.5 0 01-7 0c0-1 .5-2 1-2.5l2.5-3 2.5 3z"/><path d="M2 21l7.5-7.5"/><path d="M2 21l4-4"/></svg>
              Style visuel
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-accentColor">Couleur d'accent</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-accentColor" value="#0284c7" />
                <input type="text" id="cfg-accentColorText" placeholder="#0284c7" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-titleSize">Taille des titres</label>
              <select id="cfg-titleSize">
                <option value="sm">Petit</option>
                <option value="md" selected>Moyen</option>
                <option value="lg">Grand</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-cardBorderRadius">Arrondi des cartes</label>
              <select id="cfg-cardBorderRadius">
                <option value="none">Aucun</option>
                <option value="sm">Leger</option>
                <option value="md" selected>Moyen</option>
                <option value="lg">Large</option>
                <option value="xl">Tres large</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-cardShadow">Ombre des cartes</label>
              <select id="cfg-cardShadow">
                <option value="none">Aucune</option>
                <option value="sm" selected>Legere</option>
                <option value="md">Moyenne</option>
                <option value="lg">Forte</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 4: Recherche & Filtres -->
        <div class="accordion-section" data-section="search">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Recherche & Filtres
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Barre de recherche</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showSearch" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Filtres par categorie</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showCategoryFilter" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Contenu des cartes -->
        <div class="accordion-section" data-section="cards">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
              Contenu des cartes
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Image de couverture</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showCoverImage" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Badge de categorie</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showCategoryBadge" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Date de publication</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showDate" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Auteur</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showAuthor" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Extrait</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-showExcerpt" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group" style="margin-top:0.75rem;">
              <label for="cfg-readMoreText">Texte "Lire la suite"</label>
              <input type="text" id="cfg-readMoreText" placeholder="Lire la suite" />
            </div>
          </div>
        </div>
      </div>

      <footer class="builder-controls-footer">
        <span class="save-status" id="saveStatus">Pret a publier</span>
        <button id="saveBtn" class="btn btn-primary">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          Enregistrer & Publier
        </button>
      </footer>
    </aside>

    <!-- Zone preview (droite) -->
    <div class="builder-preview">
      <div class="builder-toolbar">
        <div class="device-toggle">
          <button class="device-btn active" data-device="desktop" title="Desktop">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </button>
          <button class="device-btn" data-device="tablet" title="Tablette">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
          <button class="device-btn" data-device="mobile" title="Mobile">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
        </div>
        <a href="/blog" target="_blank" class="toolbar-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Voir le blog
        </a>
      </div>
      <div class="builder-preview-frame" id="previewFrame">
        <iframe id="blogPreview" title="Apercu du blog"></iframe>
      </div>
    </div>
  </div>

  <!-- Bouton flottant mobile -->
  <button class="builder-fab" id="openControls">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1.08-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1.08 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1.08z"/></svg>
    Parametres
  </button>

  <div id="statusMessage" style="position:fixed;top:1rem;right:1rem;z-index:200;min-width:280px;"></div>

  <style is:global>
    /* ── Builder layout ── */
    .admin-main { overflow: hidden; }
    .admin-content { display: none; }

    .blog-builder {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Controls panel ── */
    .builder-controls {
      width: 320px;
      min-width: 320px;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .builder-controls-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .builder-controls-header h2 {
      font-size: 0.9375rem;
      font-weight: 700;
      color: #0f172a;
      line-height: 1.2;
    }
    .builder-controls-header p {
      font-size: 0.6875rem;
      color: #94a3b8;
      margin-top: 0.125rem;
    }
    .builder-close-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      color: #64748b;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    .builder-close-btn:hover { color: #0f172a; background: #f1f5f9; }
    .builder-controls-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .builder-controls-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: white;
    }
    .save-status {
      font-size: 0.75rem;
      color: #94a3b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ── Accordion ── */
    .accordion-section {
      border-bottom: 1px solid #f1f5f9;
    }
    .accordion-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.1s;
    }
    .accordion-trigger:hover { background: #fafafa; }
    .accordion-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      font-weight: 600;
      color: #0f172a;
    }
    .accordion-title svg { color: #64748b; }
    .accordion-chevron {
      color: #94a3b8;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .accordion-section.collapsed .accordion-chevron {
      transform: rotate(-90deg);
    }
    .accordion-content {
      padding: 0 1.25rem 1rem;
      overflow: hidden;
      max-height: 600px;
      transition: max-height 0.25s ease, padding 0.25s ease, opacity 0.2s ease;
      opacity: 1;
    }
    .accordion-section.collapsed .accordion-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }

    /* ── Controls form ── */
    .ctrl-group {
      margin-bottom: 0.75rem;
    }
    .ctrl-group:last-child { margin-bottom: 0; }
    .ctrl-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.25rem;
    }
    .ctrl-group input[type="text"],
    .ctrl-group textarea,
    .ctrl-group select {
      width: 100%;
      height: 2rem;
      padding: 0.25rem 0.625rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      font-family: inherit;
      color: #0f172a;
      background: white;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .ctrl-group textarea {
      height: auto;
      min-height: 3.5rem;
      padding: 0.375rem 0.625rem;
      resize: vertical;
      line-height: 1.4;
    }
    .ctrl-group input:focus,
    .ctrl-group textarea:focus,
    .ctrl-group select:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.06);
    }
    .ctrl-group select { cursor: pointer; }
    .ctrl-group input::placeholder,
    .ctrl-group textarea::placeholder { color: #94a3b8; }

    /* ── Hero bg swatches ── */
    .hero-bg-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .hero-bg-option {
      border: 2px solid #e2e8f0;
      border-radius: 0.375rem;
      padding: 0.5rem 0.375rem;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .hero-bg-option:hover { border-color: #94a3b8; }
    .hero-bg-option.selected { border-color: #171717; }
    .hero-bg-option input[type="radio"] { display: none; }
    .hero-bg-preview {
      height: 24px;
      border-radius: 3px;
      margin-bottom: 0.25rem;
    }
    .hero-bg-label {
      font-size: 0.625rem;
      font-weight: 500;
      color: #475569;
    }

    /* ── Template mini cards ── */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .template-card {
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.625rem;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .template-card:hover { border-color: #94a3b8; }
    .template-card.selected { border-color: #171717; background: #f8fafc; }
    .template-card input[type="radio"] { display: none; }
    .template-card-preview {
      height: 48px;
      margin-bottom: 0.375rem;
      display: flex;
      gap: 2px;
      justify-content: center;
      align-items: center;
    }
    .template-card-preview .block {
      background: #e2e8f0;
      border-radius: 2px;
    }
    .template-card-name {
      font-weight: 600;
      font-size: 0.6875rem;
      color: #0f172a;
    }

    /* ── Toggle rows (controls) ── */
    .builder-controls .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f8fafc;
    }
    .builder-controls .toggle-row:last-of-type { border-bottom: none; }
    .toggle-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: #334155;
    }

    /* ── Color input ── */
    .color-input-wrap {
      display: flex;
      gap: 0.375rem;
      align-items: center;
    }
    .color-input-wrap input[type="color"] {
      width: 2rem;
      height: 2rem;
      padding: 2px;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      cursor: pointer;
      background: transparent;
    }
    .color-text-input {
      flex: 1;
      height: 2rem !important;
      padding: 0.25rem 0.625rem !important;
    }

    /* ── Preview area ── */
    .builder-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      overflow: hidden;
    }
    .builder-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .device-toggle {
      display: flex;
      gap: 0.25rem;
      background: #f1f5f9;
      border-radius: 0.375rem;
      padding: 0.125rem;
    }
    .device-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border: none;
      background: transparent;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #64748b;
      transition: all 0.15s;
    }
    .device-btn:hover { color: #0f172a; }
    .device-btn.active {
      background: white;
      color: #0f172a;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .toolbar-link {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
      text-decoration: none;
      padding: 0.375rem 0.625rem;
      border-radius: 0.25rem;
      transition: all 0.15s;
    }
    .toolbar-link:hover { color: #0f172a; background: #f1f5f9; }

    /* ── Preview frame ── */
    .builder-preview-frame {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 1.5rem;
      overflow: auto;
    }
    .builder-preview-frame iframe {
      width: 100%;
      max-width: 100%;
      height: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
      transition: max-width 0.3s ease;
    }

    /* ── FAB mobile ── */
    .builder-fab {
      display: none;
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      z-index: 50;
      background: #171717;
      color: white;
      border: none;
      border-radius: 2rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.15s;
    }
    .builder-fab:hover { transform: scale(1.03); }

    /* ── Responsive ── */
    @media (max-width: 1024px) {
      .builder-controls { width: 280px; min-width: 280px; }
    }
    @media (max-width: 768px) {
      .builder-controls {
        position: fixed;
        inset: 0;
        width: 100% !important;
        min-width: 100% !important;
        z-index: 60;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        border-radius: 1rem 1rem 0 0;
        border-right: none;
      }
      .builder-controls.open {
        transform: translateY(0);
      }
      .builder-close-btn { display: block; }
      .builder-fab { display: flex; }
      .builder-preview-frame { padding: 0.75rem; }
      .builder-toolbar { padding: 0.5rem 0.75rem; }
    }
  </style>

  <script>
    let currentConfig: Record<string, any> | null = null;
    let selectedTemplate = "grid";
    let selectedHeroBg = "white";
    let previewUpdateTimer: ReturnType<typeof setTimeout> | null = null;
    let colorUpdateTimer: ReturnType<typeof setTimeout> | null = null;

    function $(id: string) {
      return document.getElementById(id) as HTMLInputElement;
    }

    function showMessage(text: string, type: "success" | "error") {
      const el = document.getElementById("statusMessage")!;
      const icon = type === "success"
        ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
        : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      el.innerHTML = `<div class="alert alert-${type}">${icon} ${text}</div>`;
      setTimeout(() => { el.innerHTML = ""; }, 5000);
    }

    // ── Mock data ──
    const mockPosts = [
      {
        title: "Comment creer un site web performant en 2025",
        excerpt: "Decouvrez les meilleures pratiques pour concevoir un site web rapide, accessible et optimise pour les moteurs de recherche.",
        slug: "site-web-performant",
        coverImage: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=600&h=400&fit=crop",
        date: "2025-01-15",
        category: "Technologie",
        author: "Marie Dupont"
      },
      {
        title: "Les tendances du design UI/UX cette annee",
        excerpt: "Du glassmorphism au design inclusif, tour d'horizon des tendances qui faconnent les interfaces utilisateur modernes.",
        slug: "tendances-design",
        coverImage: "https://images.unsplash.com/photo-1561070791-2526d30994b5?w=600&h=400&fit=crop",
        date: "2025-01-10",
        category: "Design",
        author: "Lucas Martin"
      },
      {
        title: "Guide complet du marketing de contenu",
        excerpt: "Apprenez a creer une strategie de contenu efficace pour attirer et fideliser votre audience cible.",
        slug: "marketing-contenu",
        coverImage: "https://images.unsplash.com/photo-1432888498266-38ffec3eaf0a?w=600&h=400&fit=crop",
        date: "2025-01-05",
        category: "Marketing",
        author: "Sophie Bernard"
      },
      {
        title: "Introduction au no-code : creer sans coder",
        excerpt: "Les outils no-code permettent de creer des applications complexes sans ecrire une seule ligne de code. Voici comment debuter.",
        slug: "introduction-no-code",
        coverImage: "https://images.unsplash.com/photo-1551650975-87deedd944c3?w=600&h=400&fit=crop",
        date: "2024-12-28",
        category: "Technologie",
        author: "Pierre Leroy"
      },
      {
        title: "Optimiser son SEO : les fondamentaux",
        excerpt: "Le referencement naturel reste un levier majeur d'acquisition. Maitrisez les bases pour gagner en visibilite.",
        slug: "optimiser-seo",
        coverImage: "https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?w=600&h=400&fit=crop",
        date: "2024-12-20",
        category: "Marketing",
        author: "Marie Dupont"
      },
      {
        title: "Creer une identite visuelle forte",
        excerpt: "Logo, typographie, palette de couleurs : tous les elements pour construire une marque memorable et coherente.",
        slug: "identite-visuelle",
        coverImage: "https://images.unsplash.com/photo-1558655146-9f40138edfeb?w=600&h=400&fit=crop",
        date: "2024-12-15",
        category: "Design",
        author: "Lucas Martin"
      }
    ];

    const categories = [...new Set(mockPosts.map(p => p.category))];

    // ── CSS Maps (same as blog/index.astro) ──
    const radiusMap: Record<string, string> = { none: "0", sm: "0.375rem", md: "0.75rem", lg: "1rem", xl: "1.5rem" };
    const shadowMap: Record<string, string> = { none: "none", sm: "0 1px 2px rgba(0,0,0,0.05)", md: "0 4px 6px rgba(0,0,0,0.07)", lg: "0 10px 15px rgba(0,0,0,0.1)" };
    const titleSizeMap: Record<string, string> = { sm: "1rem", md: "1.125rem", lg: "1.25rem" };

    const heroBgStyles: Record<string, { bg: string; text: string; sub: string; inputBg: string }> = {
      white: { bg: "transparent", text: "#111827", sub: "#4b5563", inputBg: "#ffffff" },
      light: { bg: "#f8fafc", text: "#111827", sub: "#4b5563", inputBg: "#ffffff" },
      dark: { bg: "#0f172a", text: "#ffffff", sub: "#d1d5db", inputBg: "rgba(255,255,255,0.1)" },
      accent: { bg: "__ACCENT__", text: "#ffffff", sub: "rgba(255,255,255,0.8)", inputBg: "rgba(255,255,255,0.15)" }
    };

    // ── Gather config from controls ──
    function gatherBlogConfig() {
      return {
        accentColor: $("cfg-accentColor").value,
        cardBorderRadius: ($("cfg-cardBorderRadius") as HTMLSelectElement).value,
        cardShadow: ($("cfg-cardShadow") as HTMLSelectElement).value,
        titleSize: ($("cfg-titleSize") as HTMLSelectElement).value,
        template: selectedTemplate,
        showSearch: $("cfg-showSearch").checked,
        showCategoryFilter: $("cfg-showCategoryFilter").checked,
        heroTitle: $("cfg-heroTitle").value,
        heroSubtitle: ($("cfg-heroSubtitle") as HTMLTextAreaElement).value,
        heroBackground: selectedHeroBg,
        showExcerpt: $("cfg-showExcerpt").checked,
        showCategoryBadge: $("cfg-showCategoryBadge").checked,
        showDate: $("cfg-showDate").checked,
        showAuthor: $("cfg-showAuthor").checked,
        showCoverImage: $("cfg-showCoverImage").checked,
        readMoreText: $("cfg-readMoreText").value,
      };
    }

    // ── Format date like fr-FR ──
    function formatDate(dateStr: string) {
      return new Date(dateStr).toLocaleDateString("fr-FR", {
        year: "numeric", month: "long", day: "numeric"
      });
    }

    // ── Preview HTML generators ──
    function gridCardHTML(post: typeof mockPosts[0], cfg: ReturnType<typeof gatherBlogConfig>) {
      const accent = cfg.accentColor;
      return `<a href="#" class="blog-card block group" style="border-radius:var(--cardRadius);box-shadow:var(--cardShadow);border:1px solid #f3f4f6;background:white;overflow:hidden;text-decoration:none;display:block;transition:box-shadow 0.2s;">
        ${cfg.showCoverImage ? `<img src="${post.coverImage}" alt="${post.title}" style="height:192px;width:100%;object-fit:cover;" loading="lazy" />` : ""}
        <div style="padding:1.5rem;">
          <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
            ${cfg.showCategoryBadge && post.category ? `<span style="font-size:0.75rem;font-weight:500;color:${accent};background:${accent}10;padding:0.25rem 0.5rem;border-radius:0.25rem;">${post.category}</span>` : ""}
            ${cfg.showDate ? `<time style="font-size:0.75rem;color:#9ca3af;">${formatDate(post.date)}</time>` : ""}
          </div>
          ${cfg.showAuthor ? `<p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.375rem;">Par ${post.author}</p>` : ""}
          <h3 style="font-size:var(--titleSize);font-weight:600;color:#111827;margin-bottom:0.5rem;line-height:1.4;">${post.title}</h3>
          ${cfg.showExcerpt ? `<p style="color:#4b5563;font-size:0.875rem;line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">${post.excerpt}</p>` : ""}
          ${cfg.readMoreText ? `<span style="display:inline-block;margin-top:1rem;font-size:0.875rem;font-weight:500;color:${accent};">${cfg.readMoreText} &rarr;</span>` : ""}
        </div>
      </a>`;
    }

    function listCardHTML(post: typeof mockPosts[0], cfg: ReturnType<typeof gatherBlogConfig>) {
      const accent = cfg.accentColor;
      return `<a href="#" class="blog-card" style="border-radius:var(--cardRadius);box-shadow:var(--cardShadow);border:1px solid #f3f4f6;background:white;overflow:hidden;text-decoration:none;display:flex;transition:box-shadow 0.2s;">
        ${cfg.showCoverImage ? `<div style="flex-shrink:0;"><img src="${post.coverImage}" alt="${post.title}" style="height:100%;width:192px;object-fit:cover;" loading="lazy" /></div>` : ""}
        <div style="padding:1.5rem;display:flex;flex-direction:column;justify-content:center;">
          <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;">
            ${cfg.showCategoryBadge && post.category ? `<span style="font-size:0.75rem;font-weight:500;color:${accent};background:${accent}10;padding:0.25rem 0.5rem;border-radius:0.25rem;">${post.category}</span>` : ""}
            ${cfg.showDate ? `<time style="font-size:0.75rem;color:#9ca3af;">${formatDate(post.date)}</time>` : ""}
          </div>
          ${cfg.showAuthor ? `<p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.25rem;">Par ${post.author}</p>` : ""}
          <h3 style="font-size:var(--titleSize);font-weight:600;color:#111827;margin-bottom:0.5rem;line-height:1.4;">${post.title}</h3>
          ${cfg.showExcerpt ? `<p style="color:#4b5563;font-size:0.875rem;line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${post.excerpt}</p>` : ""}
          ${cfg.readMoreText ? `<span style="display:inline-block;margin-top:0.75rem;font-size:0.875rem;font-weight:500;color:${accent};">${cfg.readMoreText} &rarr;</span>` : ""}
        </div>
      </a>`;
    }

    function heroCardHTML(post: typeof mockPosts[0], cfg: ReturnType<typeof gatherBlogConfig>) {
      const accent = cfg.accentColor;
      return `<a href="#" class="blog-card" style="border-radius:var(--cardRadius);box-shadow:var(--cardShadow);border:1px solid #f3f4f6;background:white;overflow:hidden;text-decoration:none;display:block;transition:box-shadow 0.2s;">
        ${cfg.showCoverImage ? `<img src="${post.coverImage}" alt="${post.title}" style="width:100%;height:384px;object-fit:cover;" loading="lazy" />` : ""}
        <div style="padding:2rem;">
          <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
            ${cfg.showCategoryBadge && post.category ? `<span style="font-size:0.75rem;font-weight:500;color:${accent};background:${accent}10;padding:0.25rem 0.5rem;border-radius:0.25rem;">${post.category}</span>` : ""}
            ${cfg.showDate ? `<time style="font-size:0.75rem;color:#9ca3af;">${formatDate(post.date)}</time>` : ""}
          </div>
          ${cfg.showAuthor ? `<p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.375rem;">Par ${post.author}</p>` : ""}
          <h3 style="font-size:1.5rem;font-weight:700;color:#111827;margin-bottom:0.75rem;line-height:1.3;">${post.title}</h3>
          ${cfg.showExcerpt ? `<p style="color:#4b5563;font-size:1rem;line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">${post.excerpt}</p>` : ""}
          ${cfg.readMoreText ? `<span style="display:inline-block;margin-top:1rem;font-size:0.875rem;font-weight:500;color:${accent};">${cfg.readMoreText} &rarr;</span>` : ""}
        </div>
      </a>`;
    }

    function heroSectionHTML(cfg: ReturnType<typeof gatherBlogConfig>) {
      const style = { ...heroBgStyles[cfg.heroBackground] || heroBgStyles.white };
      const bgColor = style.bg === "__ACCENT__" ? cfg.accentColor : style.bg;
      const hasBg = bgColor !== "transparent";
      const inputBg = style.inputBg;

      let searchHTML = "";
      if (cfg.showSearch) {
        const borderColor = cfg.heroBackground === "dark" || cfg.heroBackground === "accent" ? "rgba(255,255,255,0.2)" : "#e5e7eb";
        const placeholderColor = cfg.heroBackground === "dark" || cfg.heroBackground === "accent" ? "rgba(255,255,255,0.5)" : "#9ca3af";
        const textColor = cfg.heroBackground === "dark" || cfg.heroBackground === "accent" ? "white" : "#111827";
        searchHTML = `<div style="position:relative;flex:1;min-width:200px;max-width:28rem;">
          <input type="text" placeholder="Rechercher un article..." style="width:100%;height:2.5rem;padding-left:2.5rem;padding-right:1rem;border:1px solid ${borderColor};border-radius:0.5rem;font-size:0.875rem;outline:none;background:${inputBg};color:${textColor};" />
          <svg style="position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);color:${placeholderColor};" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </div>`;
      }

      let categoryHTML = "";
      if (cfg.showCategoryFilter) {
        const chipStyle = cfg.heroBackground === "dark" || cfg.heroBackground === "accent"
          ? `background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.2);`
          : `background:white;color:#334155;border:1px solid #e2e8f0;`;
        const activeStyle = `background:${cfg.accentColor};color:white;border-color:${cfg.accentColor};`;
        categoryHTML = `<div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
          <span style="display:inline-block;padding:0.375rem 0.875rem;border-radius:9999px;font-size:0.8125rem;font-weight:500;cursor:pointer;${activeStyle}">Tous</span>
          ${categories.map(cat => `<span style="display:inline-block;padding:0.375rem 0.875rem;border-radius:9999px;font-size:0.8125rem;font-weight:500;cursor:pointer;${chipStyle}">${cat}</span>`).join("")}
        </div>`;
      }

      const filtersHTML = (cfg.showSearch || cfg.showCategoryFilter)
        ? `<div style="display:flex;flex-wrap:wrap;align-items:center;gap:1rem;">${searchHTML}${categoryHTML}</div>`
        : "";

      return `<section style="${hasBg ? `background:${bgColor};` : ""}padding:4rem 0;">
        <div style="max-width:72rem;margin:0 auto;padding:0 1.5rem;">
          <h1 style="font-size:2.25rem;font-weight:700;margin-bottom:1rem;color:${style.text};">${cfg.heroTitle || "Blog"}</h1>
          <p style="font-size:1.125rem;margin-bottom:2rem;color:${style.sub};">${cfg.heroSubtitle || "Decouvrez nos derniers articles et actualites."}</p>
          ${filtersHTML}
        </div>
      </section>`;
    }

    function postsHTML(cfg: ReturnType<typeof gatherBlogConfig>) {
      if (cfg.template === "grid") {
        return `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2rem;">
          ${mockPosts.map(p => gridCardHTML(p, cfg)).join("")}
        </div>`;
      }
      if (cfg.template === "list") {
        return `<div style="display:flex;flex-direction:column;gap:1.5rem;max-width:56rem;margin:0 auto;">
          ${mockPosts.map(p => listCardHTML(p, cfg)).join("")}
        </div>`;
      }
      // magazine
      const hero = mockPosts[0] ? heroCardHTML(mockPosts[0], cfg) : "";
      const rest = mockPosts.slice(1).map(p => gridCardHTML(p, cfg)).join("");
      return `${hero}
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2rem;margin-top:2.5rem;">
          ${rest}
        </div>`;
    }

    function generatePreviewHTML(cfg: ReturnType<typeof gatherBlogConfig>) {
      const accent = cfg.accentColor;
      const cssRadius = radiusMap[cfg.cardBorderRadius] || radiusMap.md;
      const cssShadow = shadowMap[cfg.cardShadow] || shadowMap.sm;
      const cssTitleSize = titleSizeMap[cfg.titleSize] || titleSizeMap.md;

      return `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"><\/script>
<script>
tailwind.config={theme:{extend:{colors:{primary:{50:"#f0f9ff",100:"#e0f2fe",200:"#bae6fd",300:"#7dd3fc",400:"#38bdf8",500:"#0ea5e9",600:"#0284c7",700:"#0369a1",800:"#075985",900:"#0c4a6e",950:"#082f49"}}}}}
<\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:white;color:#111827;-webkit-font-smoothing:antialiased;}
:root{--cardRadius:${cssRadius};--cardShadow:${cssShadow};--titleSize:${cssTitleSize};--accentColor:${accent};}
.blog-card:hover{box-shadow:${cssShadow},0 4px 12px rgba(0,0,0,0.08) !important;}
@media(max-width:768px){
  .grid-3{grid-template-columns:repeat(2,1fr) !important;}
  .list-card{flex-direction:column !important;}
  .list-card img{width:100% !important;height:192px !important;}
}
@media(max-width:480px){
  .grid-3{grid-template-columns:1fr !important;}
}
</style>
</head>
<body>
<!-- Header -->
<header style="background:white;border-bottom:1px solid #f3f4f6;">
  <nav style="max-width:72rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;">
    <a href="#" style="font-size:1.25rem;font-weight:700;color:#111827;text-decoration:none;">Mon Site</a>
    <div style="display:flex;align-items:center;gap:2rem;">
      <a href="#" style="color:#4b5563;text-decoration:none;font-size:0.875rem;font-weight:500;">Accueil</a>
      <a href="#" style="color:#4b5563;text-decoration:none;font-size:0.875rem;font-weight:500;">Blog</a>
      <a href="#" style="background:${accent};color:white;padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.875rem;font-weight:500;text-decoration:none;">Acceder a l'app</a>
    </div>
  </nav>
</header>

${heroSectionHTML(cfg)}

<!-- Posts -->
<section style="padding:3rem 0;">
  <div style="max-width:72rem;margin:0 auto;padding:0 1.5rem;">
    ${postsHTML(cfg)}
  </div>
</section>
</body>
</html>`;
    }

    // ── Preview update with debounce ──
    function updatePreview() {
      const cfg = gatherBlogConfig();
      const iframe = document.getElementById("blogPreview") as HTMLIFrameElement;
      if (iframe) {
        iframe.srcdoc = generatePreviewHTML(cfg);
      }
    }

    function schedulePreviewUpdate(delay = 150) {
      if (previewUpdateTimer) clearTimeout(previewUpdateTimer);
      previewUpdateTimer = setTimeout(updatePreview, delay);
    }

    // ── Accordion ──
    function setupAccordions() {
      document.querySelectorAll<HTMLElement>(".accordion-trigger").forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.closest(".accordion-section")!;
          section.classList.toggle("collapsed");
        });
      });
    }

    // ── Hero background selector ──
    function renderHeroBg() {
      const container = document.getElementById("heroBgContainer")!;
      const options = [
        { value: "white", label: "Blanc", bg: "#ffffff", border: "1px solid #e2e8f0" },
        { value: "light", label: "Gris", bg: "#f8fafc", border: "1px solid #e2e8f0" },
        { value: "dark", label: "Sombre", bg: "#0f172a", border: "none" },
        { value: "accent", label: "Accent", bg: ($("cfg-accentColor")?.value || "#0284c7"), border: "none" },
      ];

      container.innerHTML = options.map(o => `
        <label class="hero-bg-option${o.value === selectedHeroBg ? " selected" : ""}">
          <input type="radio" name="heroBg" value="${o.value}" ${o.value === selectedHeroBg ? "checked" : ""} />
          <div class="hero-bg-preview" style="background:${o.bg};border:${o.border};"></div>
          <div class="hero-bg-label">${o.label}</div>
        </label>
      `).join("");

      container.querySelectorAll(".hero-bg-option").forEach(opt => {
        opt.addEventListener("click", () => {
          container.querySelectorAll(".hero-bg-option").forEach(o => o.classList.remove("selected"));
          opt.classList.add("selected");
          const radio = opt.querySelector("input") as HTMLInputElement;
          radio.checked = true;
          selectedHeroBg = radio.value;
          schedulePreviewUpdate();
        });
      });
    }

    // ── Template selector ──
    function renderTemplates() {
      const container = document.getElementById("templateContainer")!;
      const templates = [
        {
          value: "grid",
          name: "Grille",
          preview: '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;width:100%;height:100%;"><div class="block" style="background:#e2e8f0;border-radius:2px;"></div><div class="block" style="background:#e2e8f0;border-radius:2px;"></div><div class="block" style="background:#e2e8f0;border-radius:2px;"></div><div class="block" style="background:#e2e8f0;border-radius:2px;"></div><div class="block" style="background:#e2e8f0;border-radius:2px;"></div><div class="block" style="background:#e2e8f0;border-radius:2px;"></div></div>',
        },
        {
          value: "list",
          name: "Liste",
          preview: '<div style="display:flex;flex-direction:column;gap:2px;width:100%;height:100%;"><div style="height:33%;display:flex;gap:2px;"><div style="width:30%;background:#cbd5e1;border-radius:2px;"></div><div style="flex:1;background:#e2e8f0;border-radius:2px;"></div></div><div style="height:33%;display:flex;gap:2px;"><div style="width:30%;background:#cbd5e1;border-radius:2px;"></div><div style="flex:1;background:#e2e8f0;border-radius:2px;"></div></div><div style="height:33%;display:flex;gap:2px;"><div style="width:30%;background:#cbd5e1;border-radius:2px;"></div><div style="flex:1;background:#e2e8f0;border-radius:2px;"></div></div></div>',
        },
        {
          value: "magazine",
          name: "Magazine",
          preview: '<div style="display:flex;flex-direction:column;gap:2px;width:100%;height:100%;"><div style="height:55%;background:#e2e8f0;border-radius:2px;"></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;height:45%;"><div style="background:#e2e8f0;border-radius:2px;"></div><div style="background:#e2e8f0;border-radius:2px;"></div><div style="background:#e2e8f0;border-radius:2px;"></div></div></div>',
        },
      ];

      container.innerHTML = templates.map(t => `
        <label class="template-card${t.value === selectedTemplate ? " selected" : ""}">
          <input type="radio" name="blogTemplate" value="${t.value}" ${t.value === selectedTemplate ? "checked" : ""} />
          <div class="template-card-preview">${t.preview}</div>
          <div class="template-card-name">${t.name}</div>
        </label>
      `).join("");

      container.querySelectorAll(".template-card").forEach(card => {
        card.addEventListener("click", () => {
          container.querySelectorAll(".template-card").forEach(c => c.classList.remove("selected"));
          card.classList.add("selected");
          const radio = card.querySelector("input") as HTMLInputElement;
          radio.checked = true;
          selectedTemplate = radio.value;
          schedulePreviewUpdate();
        });
      });
    }

    // ── Color sync ──
    function setupColorSync() {
      const colorPicker = $("cfg-accentColor");
      const colorText = $("cfg-accentColorText");

      colorPicker.addEventListener("input", () => {
        colorText.value = colorPicker.value;
        renderHeroBg();
        if (colorUpdateTimer) clearTimeout(colorUpdateTimer);
        colorUpdateTimer = setTimeout(updatePreview, 250);
      });
      colorText.addEventListener("input", () => {
        if (/^#[0-9a-fA-F]{6}$/.test(colorText.value)) {
          colorPicker.value = colorText.value;
          renderHeroBg();
          if (colorUpdateTimer) clearTimeout(colorUpdateTimer);
          colorUpdateTimer = setTimeout(updatePreview, 250);
        }
      });
    }

    // ── Reactive binding ──
    function setupReactiveInputs() {
      // Text inputs with debounce
      ["cfg-heroTitle", "cfg-heroSubtitle", "cfg-readMoreText"].forEach(id => {
        $(id)?.addEventListener("input", () => schedulePreviewUpdate());
      });

      // Selects — immediate
      ["cfg-titleSize", "cfg-cardBorderRadius", "cfg-cardShadow"].forEach(id => {
        $(id)?.addEventListener("change", () => schedulePreviewUpdate(0));
      });

      // Toggles — immediate
      ["cfg-showSearch", "cfg-showCategoryFilter", "cfg-showCoverImage", "cfg-showCategoryBadge", "cfg-showDate", "cfg-showAuthor", "cfg-showExcerpt"].forEach(id => {
        $(id)?.addEventListener("change", () => schedulePreviewUpdate(0));
      });
    }

    // ── Device toggle ──
    function setupDeviceToggle() {
      const deviceSizes: Record<string, string> = {
        desktop: "100%",
        tablet: "768px",
        mobile: "375px"
      };

      document.querySelectorAll<HTMLButtonElement>(".device-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".device-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const device = btn.dataset.device || "desktop";
          const iframe = document.getElementById("blogPreview") as HTMLIFrameElement;
          iframe.style.maxWidth = deviceSizes[device];
        });
      });
    }

    // ── Mobile controls toggle ──
    function setupMobileControls() {
      const controls = document.getElementById("builderControls")!;
      const openBtn = document.getElementById("openControls")!;
      const closeBtn = document.getElementById("closeControls")!;

      openBtn.addEventListener("click", () => {
        controls.classList.add("open");
      });
      closeBtn.addEventListener("click", () => {
        controls.classList.remove("open");
      });
    }

    // ── Load config ──
    async function loadConfig() {
      try {
        const res = await fetch("/api/admin/config");
        if (res.status === 401) { window.location.href = "/admin/login"; return; }
        const data = await res.json();

        if (!data.config) {
          showMessage("Aucune configuration trouvee.", "error");
          document.getElementById("loadingOverlay")!.classList.add("hidden");
          return;
        }

        currentConfig = data.config;
        const bc = currentConfig!.blogConfig || {};

        // Hero
        $("cfg-heroTitle").value = bc.heroTitle || "Blog";
        ($("cfg-heroSubtitle") as HTMLTextAreaElement).value = bc.heroSubtitle || "";
        selectedHeroBg = bc.heroBackground || "white";

        // Template
        selectedTemplate = bc.template || currentConfig!.blogTemplate || "grid";

        // Style
        $("cfg-accentColor").value = bc.accentColor || "#0284c7";
        $("cfg-accentColorText").value = bc.accentColor || "#0284c7";
        ($("cfg-titleSize") as HTMLSelectElement).value = bc.titleSize || "md";
        ($("cfg-cardBorderRadius") as HTMLSelectElement).value = bc.cardBorderRadius || "md";
        ($("cfg-cardShadow") as HTMLSelectElement).value = bc.cardShadow || "sm";

        // Search & Filters
        $("cfg-showSearch").checked = bc.showSearch ?? false;
        $("cfg-showCategoryFilter").checked = bc.showCategoryFilter ?? false;

        // Card content
        $("cfg-showCoverImage").checked = bc.showCoverImage ?? true;
        $("cfg-showCategoryBadge").checked = bc.showCategoryBadge ?? true;
        $("cfg-showDate").checked = bc.showDate ?? true;
        $("cfg-showAuthor").checked = bc.showAuthor ?? false;
        $("cfg-showExcerpt").checked = bc.showExcerpt ?? true;
        $("cfg-readMoreText").value = bc.readMoreText ?? "Lire la suite";

        renderHeroBg();
        renderTemplates();
        setupColorSync();
        setupReactiveInputs();
        setupDeviceToggle();
        setupMobileControls();
        setupAccordions();

        updatePreview();

        document.getElementById("loadingOverlay")!.classList.add("hidden");
      } catch {
        showMessage("Erreur de chargement", "error");
        document.getElementById("loadingOverlay")!.classList.add("hidden");
      }
    }

    // ── Save & Deploy ──
    document.getElementById("saveBtn")!.addEventListener("click", async () => {
      const btn = document.getElementById("saveBtn") as HTMLButtonElement;
      const status = document.getElementById("saveStatus")!;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Publication...';
      status.textContent = "Sauvegarde en cours...";

      try {
        const blogConfig = gatherBlogConfig();
        const config = {
          ...currentConfig,
          blogConfig,
          blogTemplate: blogConfig.template,
        };

        const res = await fetch("/api/admin/deploy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ config }),
        });

        if (res.status === 401) { window.location.href = "/admin/login"; return; }

        const data = await res.json();
        if (data.success) {
          showMessage(data.message || "Configuration sauvegardee !", "success");
          status.textContent = "Publie avec succes";
          currentConfig = config;
        } else {
          showMessage(data.error || "Erreur lors de la sauvegarde", "error");
          status.textContent = "Erreur de publication";
        }
      } catch {
        showMessage("Erreur reseau", "error");
        status.textContent = "Erreur reseau";
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Enregistrer & Publier';
        setTimeout(() => { status.textContent = "Pret a publier"; }, 4000);
      }
    });

    // Init
    loadConfig();
  </script>
</Admin>
