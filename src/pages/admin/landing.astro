---
export const prerender = false;

import Admin from "../../layouts/Admin.astro";
import { verifySession, getSessionFromRequest } from "../../lib/admin-auth";

const token = getSessionFromRequest(Astro.request);
if (!(await verifySession(token))) {
  return Astro.redirect("/admin/login");
}
---

<Admin title="Landing Page" activePage="landing">
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-dots">
      <span></span><span></span><span></span>
    </div>
  </div>

  <div class="lp-builder" id="lpBuilder">
    <!-- Panneau controles (gauche) -->
    <aside class="builder-controls" id="builderControls">
      <header class="builder-controls-header">
        <div>
          <h2>Landing Page</h2>
          <p>Configurateur visuel</p>
        </div>
        <button class="builder-close-btn" id="closeControls" aria-label="Fermer">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </header>

      <div class="builder-controls-body" id="controlsBody">
        <!-- Section 0: Template -->
        <div class="accordion-section" data-section="template">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
              Template
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="tpl-grid" id="templateContainer"></div>
          </div>
        </div>

        <!-- Section 1: General -->
        <div class="accordion-section custom-only-section" data-section="general">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1.08-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1.08 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1.08z"/></svg>
              General
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-name">Nom du site</label>
              <input type="text" id="cfg-name" placeholder="Mon Site" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-url">URL du site</label>
              <input type="url" id="cfg-url" placeholder="https://example.com" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-description">Description (SEO)</label>
              <textarea id="cfg-description" rows="2" placeholder="Description du site..."></textarea>
            </div>
          </div>
        </div>

        <!-- Section 2: Hero -->
        <div class="accordion-section custom-only-section" data-section="hero">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
              Section Hero
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-hero-title">Titre</label>
              <input type="text" id="cfg-hero-title" placeholder="Bienvenue sur notre plateforme" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-hero-subtitle">Sous-titre</label>
              <textarea id="cfg-hero-subtitle" rows="2" placeholder="Une description convaincante..."></textarea>
            </div>
            <div class="ctrl-group">
              <label for="cfg-hero-ctaText">Texte du bouton</label>
              <input type="text" id="cfg-hero-ctaText" placeholder="Commencer" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-hero-ctaLink">Lien du bouton</label>
              <input type="text" id="cfg-hero-ctaLink" placeholder="https://..." />
            </div>
          </div>
        </div>

        <!-- Section 3: Features -->
        <div class="accordion-section custom-only-section" data-section="features">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
              Fonctionnalites
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-features-title">Titre de la section</label>
              <input type="text" id="cfg-features-title" placeholder="Pourquoi nous choisir" />
            </div>
            <div id="features-list"></div>
            <button type="button" id="addFeatureBtn" class="add-feature-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter
            </button>
          </div>
        </div>

        <!-- Section 4: CTA -->
        <div class="accordion-section custom-only-section" data-section="cta">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
              Section CTA
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-cta-title">Titre</label>
              <input type="text" id="cfg-cta-title" placeholder="Pret a commencer ?" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-cta-description">Description</label>
              <textarea id="cfg-cta-description" rows="2" placeholder="Rejoignez des milliers d'utilisateurs..."></textarea>
            </div>
            <div class="ctrl-group">
              <label for="cfg-cta-ctaText">Texte du bouton</label>
              <input type="text" id="cfg-cta-ctaText" placeholder="Essayer gratuitement" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-cta-ctaLink">Lien du bouton</label>
              <input type="text" id="cfg-cta-ctaLink" placeholder="https://..." />
            </div>
          </div>
        </div>
      </div>

      <footer class="builder-controls-footer">
        <span class="save-status" id="saveStatus">Pret a publier</span>
        <button id="saveBtn" class="btn btn-primary">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          Enregistrer & Publier
        </button>
      </footer>
    </aside>

    <!-- Zone preview (droite) -->
    <div class="builder-preview">
      <div class="builder-toolbar">
        <div class="device-toggle">
          <button class="device-btn active" data-device="desktop" title="Desktop">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </button>
          <button class="device-btn" data-device="tablet" title="Tablette">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
          <button class="device-btn" data-device="mobile" title="Mobile">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
        </div>
        <a href="/" target="_blank" class="toolbar-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Voir la page
        </a>
      </div>
      <div class="builder-preview-frame" id="previewFrame">
        <iframe id="lpPreview" title="Apercu de la landing page"></iframe>
      </div>
    </div>
  </div>

  <!-- Bouton flottant mobile -->
  <button class="builder-fab" id="openControls">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1.08-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1.08 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1.08z"/></svg>
    Parametres
  </button>

  <div id="statusMessage" style="position:fixed;top:1rem;right:1rem;z-index:200;min-width:280px;"></div>

  <style is:global>
    /* ── Builder layout ── */
    .admin-main { overflow: hidden; }
    .admin-content { display: none; }

    .lp-builder {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Controls panel ── */
    .builder-controls {
      width: 320px;
      min-width: 320px;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .builder-controls-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .builder-controls-header h2 {
      font-size: 0.9375rem;
      font-weight: 700;
      color: #0f172a;
      line-height: 1.2;
    }
    .builder-controls-header p {
      font-size: 0.6875rem;
      color: #94a3b8;
      margin-top: 0.125rem;
    }
    .builder-close-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      color: #64748b;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    .builder-close-btn:hover { color: #0f172a; background: #f1f5f9; }
    .builder-controls-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .builder-controls-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: white;
    }
    .save-status {
      font-size: 0.75rem;
      color: #94a3b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ── Accordion ── */
    .accordion-section {
      border-bottom: 1px solid #f1f5f9;
    }
    .accordion-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.1s;
    }
    .accordion-trigger:hover { background: #fafafa; }
    .accordion-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      font-weight: 600;
      color: #0f172a;
    }
    .accordion-title svg { color: #64748b; }
    .accordion-chevron {
      color: #94a3b8;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .accordion-section.collapsed .accordion-chevron {
      transform: rotate(-90deg);
    }
    .accordion-content {
      padding: 0 1.25rem 1rem;
      overflow: hidden;
      max-height: 2000px;
      transition: max-height 0.3s ease, padding 0.25s ease, opacity 0.2s ease;
      opacity: 1;
    }
    .accordion-section.collapsed .accordion-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }

    /* ── Controls form ── */
    .ctrl-group {
      margin-bottom: 0.75rem;
    }
    .ctrl-group:last-child { margin-bottom: 0; }
    .ctrl-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.25rem;
    }
    .ctrl-group input[type="text"],
    .ctrl-group input[type="url"],
    .ctrl-group textarea,
    .ctrl-group select {
      width: 100%;
      height: 2rem;
      padding: 0.25rem 0.625rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      font-family: inherit;
      color: #0f172a;
      background: white;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .ctrl-group textarea {
      height: auto;
      min-height: 3.5rem;
      padding: 0.375rem 0.625rem;
      resize: vertical;
      line-height: 1.4;
    }
    .ctrl-group input:focus,
    .ctrl-group textarea:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.06);
    }
    .ctrl-group input::placeholder,
    .ctrl-group textarea::placeholder { color: #94a3b8; }

    /* ── Feature items in controls ── */
    .feature-item {
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: #fafafa;
    }
    .feature-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .feature-item-number {
      font-size: 0.6875rem;
      font-weight: 500;
      color: #94a3b8;
    }
    .remove-feature-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #ef4444;
      font-size: 0.6875rem;
      font-weight: 500;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      transition: background 0.15s;
    }
    .remove-feature-btn:hover { background: #fef2f2; }
    .feature-row {
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 0.375rem;
      margin-bottom: 0.375rem;
    }
    .feature-row input,
    .feature-item textarea {
      width: 100%;
      height: 1.75rem;
      padding: 0.125rem 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-family: inherit;
      color: #0f172a;
      background: white;
      outline: none;
    }
    .feature-item textarea {
      height: auto;
      min-height: 2.5rem;
      padding: 0.25rem 0.5rem;
      resize: vertical;
      line-height: 1.4;
    }
    .feature-row input:focus,
    .feature-item textarea:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.06);
    }
    .add-feature-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      width: 100%;
      padding: 0.375rem;
      border: 1px dashed #cbd5e1;
      border-radius: 0.375rem;
      background: none;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      font-family: inherit;
      color: #64748b;
      margin-top: 0.5rem;
      transition: all 0.15s;
    }
    .add-feature-btn:hover { border-color: #94a3b8; color: #0f172a; background: #f8fafc; }

    /* ── Template grid ── */
    .tpl-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }
    .tpl-card {
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
      background: white;
    }
    .tpl-card:hover { border-color: #94a3b8; }
    .tpl-card.selected { border-color: #171717; background: #f8fafc; }
    .tpl-card input[type="radio"] { display: none; }
    .tpl-card-preview {
      height: 56px;
      border-radius: 4px;
      margin-bottom: 0.375rem;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      color: #94a3b8;
    }
    .tpl-card-name {
      font-weight: 600;
      font-size: 0.6875rem;
      color: #0f172a;
      line-height: 1.2;
    }
    .tpl-card-desc {
      font-size: 0.5625rem;
      color: #94a3b8;
      margin-top: 0.125rem;
    }
    .custom-only-section.sections-hidden {
      display: none;
    }

    /* ── Preview area ── */
    .builder-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      overflow: hidden;
    }
    .builder-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .device-toggle {
      display: flex;
      gap: 0.25rem;
      background: #f1f5f9;
      border-radius: 0.375rem;
      padding: 0.125rem;
    }
    .device-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border: none;
      background: transparent;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #64748b;
      transition: all 0.15s;
    }
    .device-btn:hover { color: #0f172a; }
    .device-btn.active {
      background: white;
      color: #0f172a;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .toolbar-link {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
      text-decoration: none;
      padding: 0.375rem 0.625rem;
      border-radius: 0.25rem;
      transition: all 0.15s;
    }
    .toolbar-link:hover { color: #0f172a; background: #f1f5f9; }

    /* ── Preview frame ── */
    .builder-preview-frame {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 1.5rem;
      overflow: auto;
    }
    .builder-preview-frame iframe {
      width: 100%;
      max-width: 100%;
      height: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
      transition: max-width 0.3s ease;
    }

    /* ── FAB mobile ── */
    .builder-fab {
      display: none;
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      z-index: 50;
      background: #171717;
      color: white;
      border: none;
      border-radius: 2rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.15s;
    }
    .builder-fab:hover { transform: scale(1.03); }

    /* ── Responsive ── */
    @media (max-width: 1024px) {
      .builder-controls { width: 280px; min-width: 280px; }
    }
    @media (max-width: 768px) {
      .builder-controls {
        position: fixed;
        inset: 0;
        width: 100% !important;
        min-width: 100% !important;
        z-index: 60;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        border-radius: 1rem 1rem 0 0;
        border-right: none;
      }
      .builder-controls.open {
        transform: translateY(0);
      }
      .builder-close-btn { display: block; }
      .builder-fab { display: flex; }
      .builder-preview-frame { padding: 0.75rem; }
      .builder-toolbar { padding: 0.5rem 0.75rem; }
    }
  </style>

  <script>
    interface FeatureItem {
      title: string;
      description: string;
      icon: string;
    }

    let currentConfig: Record<string, any> | null = null;
    let previewUpdateTimer: ReturnType<typeof setTimeout> | null = null;
    let featuresItems: FeatureItem[] = [];
    let selectedTemplate = "custom";
    let templateCache: Record<string, string> = {};

    const templates = [
      { id: "custom", name: "Personnalise", desc: "Vos sections", color: "linear-gradient(135deg,#f0f9ff,#fff)", icon: "✎" },
      { id: "template-1", name: "BrandAppart", desc: "Apple-style SaaS", color: "linear-gradient(135deg,#f5f5f7,#E8E8ED)", icon: "" },
      { id: "template-2", name: "Ledger", desc: "SaaS, corail", color: "linear-gradient(135deg,#fff5f0,#ffe0d6)", icon: "" },
      { id: "template-3", name: "LearnAI", desc: "EdTech, indigo", color: "linear-gradient(135deg,#eef2ff,#e0e7ff)", icon: "" },
      { id: "template-4", name: "Aethereal", desc: "Sombre, brutalist", color: "linear-gradient(135deg,#1a1a1a,#374336)", icon: "" },
      { id: "template-5", name: "Digital Dark", desc: "Design tool", color: "linear-gradient(135deg,#0f0f0f,#1a1a1a)", icon: "" },
      { id: "template-6", name: "Digital Light", desc: "Design tool v2", color: "linear-gradient(135deg,#050505,#1a1a1a)", icon: "" },
      { id: "template-7", name: "Orion", desc: "Spatial, gradients", color: "linear-gradient(135deg,#0a0a2e,#1a0a3e)", icon: "" },
    ];

    function $(id: string) {
      return document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement;
    }

    function showMessage(text: string, type: "success" | "error") {
      const el = document.getElementById("statusMessage")!;
      const icon = type === "success"
        ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
        : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      el.innerHTML = `<div class="alert alert-${type}">${icon} ${text}</div>`;
      setTimeout(() => { el.innerHTML = ""; }, 5000);
    }

    // ── Escape HTML ──
    function esc(str: string) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    // ── Template selector ──
    function renderTemplates() {
      const container = document.getElementById("templateContainer")!;
      container.innerHTML = templates.map(t => {
        const isDark = t.id === "template-4" || t.id === "template-5" || t.id === "template-6" || t.id === "template-7";
        const iconColor = isDark ? "rgba(255,255,255,0.5)" : "#94a3b8";
        return `
        <label class="tpl-card${t.id === selectedTemplate ? " selected" : ""}">
          <input type="radio" name="landingTemplate" value="${t.id}" ${t.id === selectedTemplate ? "checked" : ""} />
          <div class="tpl-card-preview" style="background:${t.color};color:${iconColor};font-size:1.25rem;">${t.icon}</div>
          <div class="tpl-card-name">${t.name}</div>
          <div class="tpl-card-desc">${t.desc}</div>
        </label>`;
      }).join("");

      container.querySelectorAll(".tpl-card").forEach(card => {
        card.addEventListener("click", () => {
          container.querySelectorAll(".tpl-card").forEach(c => c.classList.remove("selected"));
          card.classList.add("selected");
          const radio = card.querySelector("input") as HTMLInputElement;
          radio.checked = true;
          selectedTemplate = radio.value;
          toggleCustomSections();
          updatePreview();
        });
      });
    }

    function toggleCustomSections() {
      const isCustom = selectedTemplate === "custom";
      document.querySelectorAll<HTMLElement>(".custom-only-section").forEach(el => {
        if (isCustom) {
          el.classList.remove("sections-hidden");
        } else {
          el.classList.add("sections-hidden");
        }
      });
    }

    async function loadTemplateHTML(templateId: string): Promise<string> {
      if (templateCache[templateId]) return templateCache[templateId];
      try {
        const res = await fetch(`/templates/${templateId}.html`);
        if (!res.ok) throw new Error("Fetch failed");
        const html = await res.text();
        templateCache[templateId] = html;
        return html;
      } catch {
        return `<html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#94a3b8;">Erreur de chargement du template</body></html>`;
      }
    }

    // ── Gather config from controls ──
    function gatherConfig(): Record<string, any> {
      return {
        ...currentConfig,
        name: $("cfg-name").value,
        description: $("cfg-description").value,
        url: $("cfg-url").value,
        defaultLanguage: currentConfig?.defaultLanguage || "fr",
        landingTemplate: selectedTemplate,
        hero: {
          title: $("cfg-hero-title").value,
          subtitle: $("cfg-hero-subtitle").value,
          ctaText: $("cfg-hero-ctaText").value,
          ctaLink: $("cfg-hero-ctaLink").value,
        },
        features: {
          title: $("cfg-features-title").value,
          items: featuresItems,
        },
        cta: {
          title: $("cfg-cta-title").value,
          description: $("cfg-cta-description").value,
          ctaText: $("cfg-cta-ctaText").value,
          ctaLink: $("cfg-cta-ctaLink").value,
        },
      };
    }

    // ── Preview HTML generators ──
    function headerHTML(cfg: Record<string, any>) {
      const name = esc(cfg.name || "Mon Site");
      return `<header style="background:white;border-bottom:1px solid #f3f4f6;">
        <nav style="max-width:72rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;">
          <a href="#" style="font-size:1.25rem;font-weight:700;color:#111827;text-decoration:none;">${name}</a>
          <div style="display:flex;align-items:center;gap:2rem;">
            <a href="#" style="color:#4b5563;text-decoration:none;font-size:0.875rem;font-weight:500;">Accueil</a>
            <a href="#" style="color:#4b5563;text-decoration:none;font-size:0.875rem;font-weight:500;">Blog</a>
            <a href="#" style="background:#0284c7;color:white;padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.875rem;font-weight:500;text-decoration:none;">Acceder a l'app</a>
          </div>
        </nav>
      </header>`;
    }

    function heroSectionHTML(cfg: Record<string, any>) {
      const hero = cfg.hero || {};
      const title = esc(hero.title || "Votre titre principal ici");
      const subtitle = esc(hero.subtitle || "Une description convaincante de votre produit ou service.");
      const ctaText = esc(hero.ctaText || "Commencer");
      return `<section style="position:relative;overflow:hidden;background:linear-gradient(to bottom,#f0f9ff,white);">
        <div style="max-width:72rem;margin:0 auto;padding:6rem 1.5rem;text-align:center;">
          <h1 style="font-size:3rem;font-weight:700;letter-spacing:-0.025em;color:#111827;line-height:1.1;">${title}</h1>
          <p style="margin-top:1.5rem;font-size:1.25rem;color:#4b5563;max-width:42rem;margin-left:auto;margin-right:auto;line-height:1.6;">${subtitle}</p>
          <div style="margin-top:2.5rem;display:flex;justify-content:center;gap:1rem;">
            <a href="#" style="border-radius:0.5rem;background:#0284c7;padding:0.75rem 1.5rem;font-size:1rem;font-weight:600;color:white;text-decoration:none;box-shadow:0 1px 2px rgba(0,0,0,0.05);">${ctaText}</a>
            <a href="#" style="border-radius:0.5rem;border:1px solid #d1d5db;background:white;padding:0.75rem 1.5rem;font-size:1rem;font-weight:600;color:#374151;text-decoration:none;box-shadow:0 1px 2px rgba(0,0,0,0.05);">Lire le blog</a>
          </div>
        </div>
      </section>`;
    }

    function featuresSectionHTML(cfg: Record<string, any>) {
      const features = cfg.features || {};
      const title = esc(features.title || "Pourquoi nous choisir");
      const items: FeatureItem[] = features.items || [];

      if (items.length === 0) return "";

      const cardsHTML = items.map(f => `
        <div style="border-radius:0.75rem;border:1px solid #f3f4f6;background:white;padding:2rem;box-shadow:0 1px 2px rgba(0,0,0,0.05);transition:box-shadow 0.2s;">
          <div style="display:flex;width:3rem;height:3rem;align-items:center;justify-content:center;border-radius:0.5rem;background:#e0f2fe;color:#0369a1;font-weight:700;font-size:1.125rem;margin-bottom:1rem;">${esc(f.icon)}</div>
          <h3 style="font-size:1.125rem;font-weight:600;color:#111827;margin-bottom:0.5rem;">${esc(f.title)}</h3>
          <p style="color:#4b5563;line-height:1.6;">${esc(f.description)}</p>
        </div>
      `).join("");

      return `<section style="padding:5rem 0;">
        <div style="max-width:72rem;margin:0 auto;padding:0 1.5rem;">
          <h2 style="font-size:1.875rem;font-weight:700;text-align:center;color:#111827;margin-bottom:3rem;">${title}</h2>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2rem;">
            ${cardsHTML}
          </div>
        </div>
      </section>`;
    }

    function ctaSectionHTML(cfg: Record<string, any>) {
      const cta = cfg.cta || {};
      const title = esc(cta.title || "Pret a commencer ?");
      const description = esc(cta.description || "Rejoignez-nous et decouvrez comment notre solution peut vous aider.");
      const ctaText = esc(cta.ctaText || "Essayer gratuitement");

      return `<section style="padding:5rem 0;">
        <div style="max-width:56rem;margin:0 auto;padding:0 1.5rem;">
          <div style="border-radius:1rem;background:#0284c7;padding:2rem 2rem 4rem;text-align:center;">
            <h2 style="font-size:1.875rem;font-weight:700;color:white;margin-bottom:1rem;">${title}</h2>
            <p style="color:#e0f2fe;font-size:1.125rem;margin-bottom:2rem;max-width:36rem;margin-left:auto;margin-right:auto;">${description}</p>
            <a href="#" style="display:inline-block;border-radius:0.5rem;background:white;padding:0.75rem 2rem;font-size:1rem;font-weight:600;color:#0369a1;text-decoration:none;box-shadow:0 1px 2px rgba(0,0,0,0.05);">${ctaText}</a>
          </div>
        </div>
      </section>`;
    }

    function generatePreviewHTML(cfg: Record<string, any>) {
      return `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"><\/script>
<script>
tailwind.config={theme:{extend:{colors:{primary:{50:"#f0f9ff",100:"#e0f2fe",200:"#bae6fd",300:"#7dd3fc",400:"#38bdf8",500:"#0ea5e9",600:"#0284c7",700:"#0369a1",800:"#075985",900:"#0c4a6e",950:"#082f49"}}}}}
<\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:white;color:#111827;-webkit-font-smoothing:antialiased;}
@media(max-width:768px){
  .features-grid{grid-template-columns:1fr !important;}
  .hero-title{font-size:2rem !important;}
  .hero-buttons{flex-direction:column !important;align-items:center !important;}
}
</style>
</head>
<body>
${headerHTML(cfg)}
${heroSectionHTML(cfg)}
${featuresSectionHTML(cfg)}
${ctaSectionHTML(cfg)}
</body>
</html>`;
    }

    // ── Preview update with debounce ──
    async function updatePreview() {
      const iframe = document.getElementById("lpPreview") as HTMLIFrameElement;
      if (!iframe) return;

      if (selectedTemplate === "custom") {
        const cfg = gatherConfig();
        iframe.srcdoc = generatePreviewHTML(cfg);
      } else {
        const html = await loadTemplateHTML(selectedTemplate);
        iframe.srcdoc = html;
      }
    }

    function schedulePreviewUpdate(delay = 150) {
      if (previewUpdateTimer) clearTimeout(previewUpdateTimer);
      previewUpdateTimer = setTimeout(updatePreview, delay);
    }

    // ── Accordion ──
    function setupAccordions() {
      document.querySelectorAll<HTMLElement>(".accordion-trigger").forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.closest(".accordion-section")!;
          section.classList.toggle("collapsed");
        });
      });
    }

    // ── Features management ──
    function renderFeatures() {
      const container = document.getElementById("features-list")!;
      container.innerHTML = "";

      featuresItems.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "feature-item";
        div.innerHTML = `
          <div class="feature-item-header">
            <span class="feature-item-number">Fonctionnalite ${i + 1}</span>
            <button type="button" class="remove-feature-btn" data-index="${i}">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
              Suppr.
            </button>
          </div>
          <div class="feature-row">
            <input type="text" class="feature-icon" data-index="${i}" value="${item.icon}" placeholder="Ic." />
            <input type="text" class="feature-title" data-index="${i}" value="${item.title}" placeholder="Titre" />
          </div>
          <textarea class="feature-desc" data-index="${i}" placeholder="Description..." style="font-size:0.75rem;">${item.description}</textarea>
        `;
        container.appendChild(div);
      });

      // Remove buttons
      container.querySelectorAll(".remove-feature-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const idx = parseInt((e.currentTarget as HTMLElement).dataset.index!);
          featuresItems.splice(idx, 1);
          renderFeatures();
          schedulePreviewUpdate(0);
        });
      });

      // Input sync
      container.querySelectorAll(".feature-icon, .feature-title, .feature-desc").forEach(input => {
        input.addEventListener("input", (e) => {
          const el = e.target as HTMLInputElement | HTMLTextAreaElement;
          const idx = parseInt(el.dataset.index!);
          if (el.classList.contains("feature-icon")) featuresItems[idx].icon = el.value;
          if (el.classList.contains("feature-title")) featuresItems[idx].title = el.value;
          if (el.classList.contains("feature-desc")) featuresItems[idx].description = el.value;
          schedulePreviewUpdate();
        });
      });
    }

    // ── Reactive binding ──
    function setupReactiveInputs() {
      const textIds = [
        "cfg-name", "cfg-description", "cfg-url",
        "cfg-hero-title", "cfg-hero-subtitle", "cfg-hero-ctaText", "cfg-hero-ctaLink",
        "cfg-features-title",
        "cfg-cta-title", "cfg-cta-description", "cfg-cta-ctaText", "cfg-cta-ctaLink"
      ];
      textIds.forEach(id => {
        $(id)?.addEventListener("input", () => schedulePreviewUpdate());
      });
    }

    // ── Device toggle ──
    function setupDeviceToggle() {
      const deviceSizes: Record<string, string> = {
        desktop: "100%",
        tablet: "768px",
        mobile: "375px"
      };

      document.querySelectorAll<HTMLButtonElement>(".device-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".device-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const device = btn.dataset.device || "desktop";
          const iframe = document.getElementById("lpPreview") as HTMLIFrameElement;
          iframe.style.maxWidth = deviceSizes[device];
        });
      });
    }

    // ── Mobile controls toggle ──
    function setupMobileControls() {
      const controls = document.getElementById("builderControls")!;
      const openBtn = document.getElementById("openControls")!;
      const closeBtn = document.getElementById("closeControls")!;

      openBtn.addEventListener("click", () => controls.classList.add("open"));
      closeBtn.addEventListener("click", () => controls.classList.remove("open"));
    }

    // ── Load config ──
    async function loadConfig() {
      try {
        const res = await fetch("/api/admin/config");
        if (res.status === 401) { window.location.href = "/admin/login"; return; }
        const data = await res.json();

        if (!data.config) {
          showMessage("Aucune configuration trouvee.", "error");
          document.getElementById("loadingOverlay")!.classList.add("hidden");
          return;
        }

        currentConfig = data.config;
        const c = currentConfig!;

        $("cfg-name").value = c.name || "";
        $("cfg-description").value = c.description || "";
        $("cfg-url").value = c.url || "";

        $("cfg-hero-title").value = c.hero?.title || "";
        $("cfg-hero-subtitle").value = c.hero?.subtitle || "";
        $("cfg-hero-ctaText").value = c.hero?.ctaText || "";
        $("cfg-hero-ctaLink").value = c.hero?.ctaLink || "";

        $("cfg-features-title").value = c.features?.title || "";
        featuresItems = c.features?.items || [];
        renderFeatures();

        $("cfg-cta-title").value = c.cta?.title || "";
        $("cfg-cta-description").value = c.cta?.description || "";
        $("cfg-cta-ctaText").value = c.cta?.ctaText || "";
        $("cfg-cta-ctaLink").value = c.cta?.ctaLink || "";

        // Template
        selectedTemplate = c.landingTemplate || "custom";
        renderTemplates();
        toggleCustomSections();

        setupAccordions();
        setupReactiveInputs();
        setupDeviceToggle();
        setupMobileControls();

        updatePreview();

        document.getElementById("loadingOverlay")!.classList.add("hidden");
      } catch {
        showMessage("Erreur de chargement de la configuration", "error");
        document.getElementById("loadingOverlay")!.classList.add("hidden");
      }
    }

    // ── Save & Deploy ──
    document.getElementById("saveBtn")!.addEventListener("click", async () => {
      const btn = document.getElementById("saveBtn") as HTMLButtonElement;
      const status = document.getElementById("saveStatus")!;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Publication...';
      status.textContent = "Sauvegarde en cours...";

      try {
        const config = gatherConfig();
        const res = await fetch("/api/admin/deploy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ config }),
        });

        if (res.status === 401) { window.location.href = "/admin/login"; return; }

        const data = await res.json();
        if (data.success) {
          showMessage(data.message || "Configuration sauvegardee !", "success");
          status.textContent = "Publie avec succes";
          currentConfig = config;
        } else {
          showMessage(data.error || "Erreur lors de la sauvegarde", "error");
          status.textContent = "Erreur de publication";
        }
      } catch {
        showMessage("Erreur reseau", "error");
        status.textContent = "Erreur reseau";
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Enregistrer & Publier';
        setTimeout(() => { status.textContent = "Pret a publier"; }, 4000);
      }
    });

    // ── Add feature ──
    document.getElementById("addFeatureBtn")!.addEventListener("click", () => {
      featuresItems.push({
        title: "Nouvelle fonctionnalite",
        description: "Description de la fonctionnalite",
        icon: String(featuresItems.length + 1),
      });
      renderFeatures();
      schedulePreviewUpdate(0);
    });

    // Init
    loadConfig();
  </script>
</Admin>
