---
export const prerender = false;

import Admin from "../../layouts/Admin.astro";
import { verifySession, getSessionFromRequest } from "../../lib/admin-auth";

const token = getSessionFromRequest(Astro.request);
if (!(await verifySession(token))) {
  return Astro.redirect("/admin/login");
}
---

<Admin title="Landing Page" activePage="landing">
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-dots">
      <span></span><span></span><span></span>
    </div>
  </div>

  <div class="landing-builder" id="landingBuilder">
    <!-- Panneau controles (gauche) -->
    <aside class="builder-controls" id="builderControls">
      <header class="builder-controls-header">
        <div>
          <h2>Landing Page</h2>
          <p>Configurateur visuel</p>
        </div>
        <button class="builder-close-btn" id="closeControls" aria-label="Fermer">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </header>

      <div class="builder-controls-body" id="controlsBody">

        <!-- Section 1: Couleurs & Typographie -->
        <div class="accordion-section" data-section="global">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17.5 10.5c.5.5 1 1.5 1 2.5a3.5 3.5 0 01-7 0c0-1 .5-2 1-2.5l2.5-3 2.5 3z"/><path d="M2 21l7.5-7.5"/><path d="M2 21l4-4"/></svg>
              Couleurs & Typographie
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="ctrl-group">
              <label for="cfg-accentColor">Couleur d'accent</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-accentColor" value="#5700FF" />
                <input type="text" id="cfg-accentColorText" placeholder="#5700FF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-pageBgColor">Fond de page</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-pageBgColor" value="#FAFAF8" />
                <input type="text" id="cfg-pageBgColorText" placeholder="#FAFAF8" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-headingFont">Police des titres</label>
              <select id="cfg-headingFont">
                <option value="Plus Jakarta Sans" selected>Plus Jakarta Sans</option>
                <option value="Inter">Inter</option>
                <option value="Montserrat">Montserrat</option>
                <option value="Poppins">Poppins</option>
                <option value="Roboto">Roboto</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-bodyFont">Police du corps</label>
              <select id="cfg-bodyFont">
                <option value="Inter" selected>Inter</option>
                <option value="Plus Jakarta Sans">Plus Jakarta Sans</option>
                <option value="Roboto">Roboto</option>
                <option value="Open Sans">Open Sans</option>
                <option value="Lato">Lato</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 2: Hero -->
        <div class="accordion-section" data-section="hero">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              Hero
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-heroVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroMinHeight">Hauteur minimale</label>
              <select id="cfg-heroMinHeight">
                <option value="50vh">50vh</option>
                <option value="60vh">60vh</option>
                <option value="70vh" selected>70vh</option>
                <option value="80vh">80vh</option>
                <option value="90vh">90vh</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label>Opacite de l'overlay <span class="range-value" id="heroOverlayVal">50</span>%</label>
              <input type="range" id="cfg-heroOverlayOpacity" min="0" max="100" value="50" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroOverlayColor">Couleur de l'overlay</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-heroOverlayColor" value="#000000" />
                <input type="text" id="cfg-heroOverlayColorText" placeholder="#000000" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroGradientFrom">Degrade depuis</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-heroGradientFrom" value="#5700FF" />
                <input type="text" id="cfg-heroGradientFromText" placeholder="#5700FF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroGradientTo">Degrade vers</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-heroGradientTo" value="#350099" />
                <input type="text" id="cfg-heroGradientToText" placeholder="#350099" class="color-text-input" />
              </div>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Afficher le logo</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-heroShowLogo" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroLogoHeight">Taille du logo</label>
              <select id="cfg-heroLogoHeight">
                <option value="h-12">h-12</option>
                <option value="h-16">h-16</option>
                <option value="h-20" selected>h-20</option>
                <option value="h-24">h-24</option>
                <option value="h-32">h-32</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroLogoRadius">Arrondi du logo</label>
              <select id="cfg-heroLogoRadius">
                <option value="rounded-none">Aucun</option>
                <option value="rounded-lg">Leger</option>
                <option value="rounded-2xl" selected>Moyen</option>
                <option value="rounded-full">Cercle</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label>Opacite fond du logo <span class="range-value" id="heroLogoBgOpacityVal">10</span>%</label>
              <input type="range" id="cfg-heroLogoBgOpacity" min="0" max="100" value="10" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroTitleFontSize">Taille du titre</label>
              <select id="cfg-heroTitleFontSize">
                <option value="text-3xl">text-3xl</option>
                <option value="text-4xl" selected>text-4xl</option>
                <option value="text-5xl">text-5xl</option>
                <option value="text-6xl">text-6xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroTitleColor">Couleur du titre</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-heroTitleColor" value="#ffffff" />
                <input type="text" id="cfg-heroTitleColorText" placeholder="#ffffff" class="color-text-input" />
              </div>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Afficher le slogan</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-heroShowSlogan" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroSloganFontSize">Taille du slogan</label>
              <select id="cfg-heroSloganFontSize">
                <option value="text-lg">text-lg</option>
                <option value="text-xl" selected>text-xl</option>
                <option value="text-2xl">text-2xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroSloganColor">Couleur du slogan</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-heroSloganColor" value="#e6e6e6" />
                <input type="text" id="cfg-heroSloganColorText" placeholder="rgba(255,255,255,0.9)" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-heroVerticalPadding">Espacement vertical</label>
              <select id="cfg-heroVerticalPadding">
                <option value="py-16">py-16</option>
                <option value="py-20">py-20</option>
                <option value="py-24" selected>py-24</option>
                <option value="py-32">py-32</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 3: Description -->
        <div class="accordion-section" data-section="description">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
              Description
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-descVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descMaxWidth">Largeur max</label>
              <select id="cfg-descMaxWidth">
                <option value="max-w-2xl">max-w-2xl</option>
                <option value="max-w-3xl" selected>max-w-3xl</option>
                <option value="max-w-4xl">max-w-4xl</option>
                <option value="max-w-5xl">max-w-5xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descFontSize">Taille du texte</label>
              <select id="cfg-descFontSize">
                <option value="prose-base">prose-base</option>
                <option value="prose-lg" selected>prose-lg</option>
                <option value="prose-xl">prose-xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descTextColor">Couleur du texte</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-descTextColor" value="#4B5563" />
                <input type="text" id="cfg-descTextColorText" placeholder="#4B5563" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descTextAlign">Alignement</label>
              <select id="cfg-descTextAlign">
                <option value="text-left" selected>Gauche</option>
                <option value="text-center">Centre</option>
                <option value="text-justify">Justifie</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descBgColor">Couleur de fond</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-descBgColor" value="#FAFAF8" />
                <input type="text" id="cfg-descBgColorText" placeholder="#FAFAF8" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-descVerticalPadding">Espacement vertical</label>
              <select id="cfg-descVerticalPadding">
                <option value="py-12">py-12</option>
                <option value="py-16">py-16</option>
                <option value="py-20" selected>py-20</option>
                <option value="py-24">py-24</option>
                <option value="py-28">py-28</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 4: Apercu Blog -->
        <div class="accordion-section" data-section="blogPreview">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2"/></svg>
              Apercu Blog
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-blogVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogBadgeText">Texte du badge</label>
              <input type="text" id="cfg-blogBadgeText" placeholder="Blog" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogSectionTitle">Titre de la section</label>
              <input type="text" id="cfg-blogSectionTitle" placeholder="Derniers articles" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogSectionSubtitle">Sous-titre</label>
              <textarea id="cfg-blogSectionSubtitle" rows="2" placeholder="Actualites, articles, interviews..."></textarea>
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogCtaText">Texte du bouton CTA</label>
              <input type="text" id="cfg-blogCtaText" placeholder="Voir tous les articles" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogPostCount">Nombre d'articles</label>
              <select id="cfg-blogPostCount">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="6">6</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogBgColor">Couleur de fond</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-blogBgColor" value="#F5F3EF" />
                <input type="text" id="cfg-blogBgColorText" placeholder="#F5F3EF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogCardRadius">Arrondi des cartes</label>
              <select id="cfg-blogCardRadius">
                <option value="rounded-lg">rounded-lg</option>
                <option value="rounded-xl">rounded-xl</option>
                <option value="rounded-2xl" selected>rounded-2xl</option>
                <option value="rounded-3xl">rounded-3xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-blogCardShadow">Ombre des cartes</label>
              <select id="cfg-blogCardShadow">
                <option value="none" selected>Aucune</option>
                <option value="shadow-sm">Legere</option>
                <option value="shadow-md">Moyenne</option>
                <option value="shadow-lg">Forte</option>
              </select>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Image de couverture</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-blogShowCoverImage" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Categorie</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-blogShowCategory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Date</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-blogShowDate" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Extrait</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-blogShowExcerpt" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group" style="margin-top:0.75rem;">
              <label for="cfg-blogVerticalPadding">Espacement vertical</label>
              <select id="cfg-blogVerticalPadding">
                <option value="py-16">py-16</option>
                <option value="py-20">py-20</option>
                <option value="py-24" selected>py-24</option>
                <option value="py-32">py-32</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 5: Contact -->
        <div class="accordion-section" data-section="contact">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              Contact
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-contactVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactHeadingText">Titre</label>
              <input type="text" id="cfg-contactHeadingText" placeholder="Contact" />
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactHeadingColor">Couleur du titre</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactHeadingColor" value="#111827" />
                <input type="text" id="cfg-contactHeadingColorText" placeholder="#111827" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactBgColor">Couleur de fond</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactBgColor" value="#F5F3EF" />
                <input type="text" id="cfg-contactBgColorText" placeholder="#F5F3EF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactCardRadius">Arrondi des cartes</label>
              <select id="cfg-contactCardRadius">
                <option value="rounded-lg">rounded-lg</option>
                <option value="rounded-xl">rounded-xl</option>
                <option value="rounded-2xl" selected>rounded-2xl</option>
                <option value="rounded-3xl">rounded-3xl</option>
              </select>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactCardBgColor">Fond des cartes</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactCardBgColor" value="#ffffff" />
                <input type="text" id="cfg-contactCardBgColorText" placeholder="#ffffff" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactIconBgColor">Fond des icones</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactIconBgColor" value="#f3eeff" />
                <input type="text" id="cfg-contactIconBgColorText" placeholder="#f3eeff" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactIconColor">Couleur des icones</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactIconColor" value="#5700FF" />
                <input type="text" id="cfg-contactIconColorText" placeholder="#5700FF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactLinkColor">Couleur des liens</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-contactLinkColor" value="#5700FF" />
                <input type="text" id="cfg-contactLinkColorText" placeholder="#5700FF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-contactVerticalPadding">Espacement vertical</label>
              <select id="cfg-contactVerticalPadding">
                <option value="py-12">py-12</option>
                <option value="py-16">py-16</option>
                <option value="py-20" selected>py-20</option>
                <option value="py-24">py-24</option>
                <option value="py-28">py-28</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 6: En-tete -->
        <div class="accordion-section" data-section="header">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
              En-tete
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-headerVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-headerScrollBgColor">Fond au scroll</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-headerScrollBgColor" value="#FAFAF8" />
                <input type="text" id="cfg-headerScrollBgColorText" placeholder="rgba(250,250,248,0.8)" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-headerNameColor">Couleur du nom</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-headerNameColor" value="#111827" />
                <input type="text" id="cfg-headerNameColorText" placeholder="#111827" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-headerLinkColor">Couleur des liens</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-headerLinkColor" value="#4B5563" />
                <input type="text" id="cfg-headerLinkColorText" placeholder="#4B5563" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-headerLinkHoverColor">Couleur liens hover</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-headerLinkHoverColor" value="#111827" />
                <input type="text" id="cfg-headerLinkHoverColorText" placeholder="#111827" class="color-text-input" />
              </div>
            </div>
          </div>
        </div>

        <!-- Section 7: Pied de page -->
        <div class="accordion-section" data-section="footer">
          <button class="accordion-trigger" type="button">
            <span class="accordion-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="15" x2="21" y2="15"/></svg>
              Pied de page
            </span>
            <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="accordion-content">
            <div class="toggle-row">
              <span class="toggle-label">Visible</span>
              <label class="toggle">
                <input type="checkbox" id="cfg-footerVisible" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="ctrl-group">
              <label for="cfg-footerBgColor">Couleur de fond</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-footerBgColor" value="#5700FF" />
                <input type="text" id="cfg-footerBgColorText" placeholder="#5700FF" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-footerTextColor">Couleur du texte</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-footerTextColor" value="#ffffff" />
                <input type="text" id="cfg-footerTextColorText" placeholder="#ffffff" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-footerLinkColor">Couleur des liens</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-footerLinkColor" value="#9999ff" />
                <input type="text" id="cfg-footerLinkColorText" placeholder="rgba(255,255,255,0.6)" class="color-text-input" />
              </div>
            </div>
            <div class="ctrl-group">
              <label for="cfg-footerCopyrightColor">Couleur du copyright</label>
              <div class="color-input-wrap">
                <input type="color" id="cfg-footerCopyrightColor" value="#666699" />
                <input type="text" id="cfg-footerCopyrightColorText" placeholder="rgba(255,255,255,0.4)" class="color-text-input" />
              </div>
            </div>
          </div>
        </div>

      </div>

      <footer class="builder-controls-footer">
        <span class="save-status" id="saveStatus">Pret a publier</span>
        <button id="saveBtn" class="btn btn-primary">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          Enregistrer & Publier
        </button>
      </footer>
    </aside>

    <!-- Resize handle -->
    <div class="resize-handle" id="resizeHandle"><div class="resize-handle-line"></div></div>

    <!-- Zone preview (droite) -->
    <div class="builder-preview">
      <div class="builder-toolbar">
        <div class="device-toggle">
          <button class="device-btn active" data-device="desktop" title="Desktop">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </button>
          <button class="device-btn" data-device="tablet" title="Tablette">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
          <button class="device-btn" data-device="mobile" title="Mobile">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </button>
        </div>
        <a href="/" target="_blank" class="toolbar-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Voir le site
        </a>
      </div>
      <div class="builder-preview-frame" id="previewFrame">
        <iframe id="landingPreview" title="Apercu de la landing page"></iframe>
      </div>
    </div>
  </div>

  <!-- Bouton flottant mobile -->
  <button class="builder-fab" id="openControls">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1.08-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1.08 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1.08z"/></svg>
    Parametres
  </button>

  <div id="statusMessage" style="position:fixed;top:1rem;right:1rem;z-index:200;min-width:280px;"></div>

  <style is:global>
    /* ── Builder layout ── */
    .admin-main { overflow: hidden; }
    .admin-content { display: none; }

    .landing-builder {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Controls panel ── */
    .builder-controls {
      width: 320px;
      min-width: 240px;
      max-width: 50vw;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .builder-controls-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .builder-controls-header h2 {
      font-size: 0.9375rem;
      font-weight: 700;
      color: #0f172a;
      line-height: 1.2;
    }
    .builder-controls-header p {
      font-size: 0.6875rem;
      color: #94a3b8;
      margin-top: 0.125rem;
    }
    .builder-close-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      color: #64748b;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    .builder-close-btn:hover { color: #0f172a; background: #f1f5f9; }
    .builder-controls-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .builder-controls-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: white;
    }
    .save-status {
      font-size: 0.75rem;
      color: #94a3b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ── Accordion ── */
    .accordion-section {
      border-bottom: 1px solid #f1f5f9;
    }
    .accordion-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 1.25rem;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.1s;
    }
    .accordion-trigger:hover { background: #fafafa; }
    .accordion-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      font-weight: 600;
      color: #0f172a;
    }
    .accordion-title svg { color: #64748b; }
    .accordion-chevron {
      color: #94a3b8;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .accordion-section.collapsed .accordion-chevron {
      transform: rotate(-90deg);
    }
    .accordion-content {
      padding: 0 1.25rem 1rem;
      overflow: hidden;
      max-height: 1200px;
      transition: max-height 0.25s ease, padding 0.25s ease, opacity 0.2s ease;
      opacity: 1;
    }
    .accordion-section.collapsed .accordion-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }

    /* ── Controls form ── */
    .ctrl-group {
      margin-bottom: 0.75rem;
    }
    .ctrl-group:last-child { margin-bottom: 0; }
    .ctrl-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.25rem;
    }
    .ctrl-group input[type="text"],
    .ctrl-group textarea,
    .ctrl-group select {
      width: 100%;
      height: 2rem;
      padding: 0.25rem 0.625rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      font-family: inherit;
      color: #0f172a;
      background: white;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .ctrl-group textarea {
      height: auto;
      min-height: 3.5rem;
      padding: 0.375rem 0.625rem;
      resize: vertical;
      line-height: 1.4;
    }
    .ctrl-group input:focus,
    .ctrl-group textarea:focus,
    .ctrl-group select:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.06);
    }
    .ctrl-group select { cursor: pointer; }
    .ctrl-group input::placeholder,
    .ctrl-group textarea::placeholder { color: #94a3b8; }

    /* ── Range inputs ── */
    .ctrl-group input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
      margin-top: 0.25rem;
    }
    .ctrl-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #171717;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .ctrl-group input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #171717;
      cursor: pointer;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .range-value {
      font-weight: 600;
      color: #0f172a;
    }

    /* ── Toggle rows (controls) ── */
    .builder-controls .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f8fafc;
    }
    .builder-controls .toggle-row:last-of-type { border-bottom: none; }
    .toggle-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: #334155;
    }

    /* ── Color input ── */
    .color-input-wrap {
      display: flex;
      gap: 0.375rem;
      align-items: center;
    }
    .color-input-wrap input[type="color"] {
      width: 2rem;
      height: 2rem;
      padding: 2px;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      cursor: pointer;
      background: transparent;
    }
    .color-text-input {
      flex: 1;
      height: 2rem !important;
      padding: 0.25rem 0.625rem !important;
    }

    /* ── Resize handle ── */
    .resize-handle {
      width: 6px;
      cursor: col-resize;
      background: transparent;
      position: relative;
      flex-shrink: 0;
      z-index: 5;
      transition: background 0.15s;
    }
    .resize-handle:hover,
    .resize-handle.dragging {
      background: #e2e8f0;
    }
    .resize-handle-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 32px;
      border-radius: 1px;
      background: #cbd5e1;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .resize-handle:hover .resize-handle-line,
    .resize-handle.dragging .resize-handle-line {
      opacity: 1;
    }
    body.resizing {
      cursor: col-resize !important;
      user-select: none !important;
    }
    body.resizing iframe {
      pointer-events: none !important;
    }

    /* ── Preview area ── */
    .builder-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      overflow: hidden;
    }
    .builder-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .device-toggle {
      display: flex;
      gap: 0.25rem;
      background: #f1f5f9;
      border-radius: 0.375rem;
      padding: 0.125rem;
    }
    .device-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border: none;
      background: transparent;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #64748b;
      transition: all 0.15s;
    }
    .device-btn:hover { color: #0f172a; }
    .device-btn.active {
      background: white;
      color: #0f172a;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .toolbar-link {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
      text-decoration: none;
      padding: 0.375rem 0.625rem;
      border-radius: 0.25rem;
      transition: all 0.15s;
    }
    .toolbar-link:hover { color: #0f172a; background: #f1f5f9; }

    /* ── Preview frame ── */
    .builder-preview-frame {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 1.5rem;
      overflow: auto;
    }
    .builder-preview-frame iframe {
      width: 100%;
      max-width: 100%;
      height: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
      transition: max-width 0.3s ease;
    }

    /* ── FAB mobile ── */
    .builder-fab {
      display: none;
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      z-index: 50;
      background: #171717;
      color: white;
      border: none;
      border-radius: 2rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.15s;
    }
    .builder-fab:hover { transform: scale(1.03); }

    /* ── Responsive ── */
    @media (max-width: 1024px) {
      .builder-controls { width: 280px; min-width: 280px; }
    }
    @media (max-width: 768px) {
      .builder-controls {
        position: fixed;
        inset: 0;
        width: 100% !important;
        min-width: 100% !important;
        z-index: 60;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        border-radius: 1rem 1rem 0 0;
        border-right: none;
      }
      .builder-controls.open {
        transform: translateY(0);
      }
      .builder-close-btn { display: block; }
      .builder-fab { display: flex; }
      .builder-preview-frame { padding: 0.75rem; }
      .builder-toolbar { padding: 0.5rem 0.75rem; }
    }
  </style>

  <script>
    let previewUpdateTimer: ReturnType<typeof setTimeout> | null = null;

    function $(id: string) {
      return document.getElementById(id) as HTMLInputElement;
    }

    function showMessage(text: string, type: "success" | "error") {
      const el = document.getElementById("statusMessage")!;
      const icon = type === "success"
        ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
        : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      el.innerHTML = `<div class="alert alert-${type}">${icon} ${text}</div>`;
      setTimeout(() => { el.innerHTML = ""; }, 5000);
    }

    // ── Mock data ──
    const mockCompany = {
      nom: "Mon Entreprise",
      slogan: "Votre slogan accrocheur ici",
      description: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.",
      email: "contact@monentreprise.fr",
      telephone: "+33 1 23 45 67 89",
      adresse: "123 Rue de la Paix, 75001 Paris"
    };

    const mockPosts = [
      {
        title: "Comment creer un site web performant",
        excerpt: "Decouvrez les meilleures pratiques pour concevoir un site web rapide et optimise.",
        coverImage: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=600&h=400&fit=crop",
        date: "2025-01-15",
        category: "Technologie"
      },
      {
        title: "Les tendances du design UI/UX",
        excerpt: "Tour d'horizon des tendances qui faconnent les interfaces utilisateur modernes.",
        coverImage: "https://images.unsplash.com/photo-1561070791-2526d30994b5?w=600&h=400&fit=crop",
        date: "2025-01-10",
        category: "Design"
      },
      {
        title: "Guide complet du marketing de contenu",
        excerpt: "Apprenez a creer une strategie de contenu efficace pour votre audience.",
        coverImage: "https://images.unsplash.com/photo-1432888498266-38ffec3eaf0a?w=600&h=400&fit=crop",
        date: "2025-01-05",
        category: "Marketing"
      }
    ];

    // ── Gather config from all controls ──
    function gatherConfig() {
      return {
        global: {
          accentColor: $("cfg-accentColor").value,
          pageBgColor: $("cfg-pageBgColor").value,
          headingFont: ($("cfg-headingFont") as HTMLSelectElement).value,
          bodyFont: ($("cfg-bodyFont") as HTMLSelectElement).value,
        },
        hero: {
          visible: $("cfg-heroVisible").checked,
          minHeight: ($("cfg-heroMinHeight") as HTMLSelectElement).value,
          overlayOpacity: parseInt($("cfg-heroOverlayOpacity").value, 10),
          overlayColor: $("cfg-heroOverlayColor").value,
          fallbackGradientFrom: $("cfg-heroGradientFrom").value,
          fallbackGradientTo: $("cfg-heroGradientTo").value,
          showLogo: $("cfg-heroShowLogo").checked,
          logoHeight: ($("cfg-heroLogoHeight") as HTMLSelectElement).value,
          logoRadius: ($("cfg-heroLogoRadius") as HTMLSelectElement).value,
          logoBgOpacity: parseInt($("cfg-heroLogoBgOpacity").value, 10),
          titleFontSize: ($("cfg-heroTitleFontSize") as HTMLSelectElement).value,
          titleColor: $("cfg-heroTitleColor").value,
          showSlogan: $("cfg-heroShowSlogan").checked,
          sloganFontSize: ($("cfg-heroSloganFontSize") as HTMLSelectElement).value,
          sloganColor: $("cfg-heroSloganColorText").value || $("cfg-heroSloganColor").value,
          verticalPadding: ($("cfg-heroVerticalPadding") as HTMLSelectElement).value,
        },
        description: {
          visible: $("cfg-descVisible").checked,
          maxWidth: ($("cfg-descMaxWidth") as HTMLSelectElement).value,
          verticalPadding: ($("cfg-descVerticalPadding") as HTMLSelectElement).value,
          textColor: $("cfg-descTextColor").value,
          fontSize: ($("cfg-descFontSize") as HTMLSelectElement).value,
          textAlign: ($("cfg-descTextAlign") as HTMLSelectElement).value,
          bgColor: $("cfg-descBgColor").value,
        },
        blogPreview: {
          visible: $("cfg-blogVisible").checked,
          postCount: parseInt(($("cfg-blogPostCount") as HTMLSelectElement).value, 10),
          verticalPadding: ($("cfg-blogVerticalPadding") as HTMLSelectElement).value,
          bgColor: $("cfg-blogBgColor").value,
          cardRadius: ($("cfg-blogCardRadius") as HTMLSelectElement).value,
          cardShadow: ($("cfg-blogCardShadow") as HTMLSelectElement).value,
          showCoverImage: $("cfg-blogShowCoverImage").checked,
          showCategory: $("cfg-blogShowCategory").checked,
          showDate: $("cfg-blogShowDate").checked,
          showExcerpt: $("cfg-blogShowExcerpt").checked,
          sectionTitle: $("cfg-blogSectionTitle").value,
          sectionSubtitle: ($("cfg-blogSectionSubtitle") as HTMLTextAreaElement).value,
          ctaText: $("cfg-blogCtaText").value,
          badgeText: $("cfg-blogBadgeText").value,
        },
        contact: {
          visible: $("cfg-contactVisible").checked,
          verticalPadding: ($("cfg-contactVerticalPadding") as HTMLSelectElement).value,
          bgColor: $("cfg-contactBgColor").value,
          cardRadius: ($("cfg-contactCardRadius") as HTMLSelectElement).value,
          cardBgColor: $("cfg-contactCardBgColor").value,
          headingText: $("cfg-contactHeadingText").value,
          headingColor: $("cfg-contactHeadingColor").value,
          iconBgColor: $("cfg-contactIconBgColor").value,
          iconColor: $("cfg-contactIconColor").value,
          linkColor: $("cfg-contactLinkColor").value,
        },
        header: {
          visible: $("cfg-headerVisible").checked,
          scrollBgColor: $("cfg-headerScrollBgColorText").value || $("cfg-headerScrollBgColor").value,
          nameColor: $("cfg-headerNameColor").value,
          linkColor: $("cfg-headerLinkColor").value,
          linkHoverColor: $("cfg-headerLinkHoverColor").value,
        },
        footer: {
          visible: $("cfg-footerVisible").checked,
          bgColor: $("cfg-footerBgColor").value,
          textColor: $("cfg-footerTextColor").value,
          linkColor: $("cfg-footerLinkColorText").value || $("cfg-footerLinkColor").value,
          copyrightColor: $("cfg-footerCopyrightColorText").value || $("cfg-footerCopyrightColor").value,
        },
      };
    }

    // ── Tailwind class → CSS value maps ──
    const twPaddingMap: Record<string, string> = {
      "py-12": "3rem", "py-16": "4rem", "py-20": "5rem", "py-24": "6rem", "py-28": "7rem", "py-32": "8rem"
    };
    const twMaxWidthMap: Record<string, string> = {
      "max-w-2xl": "42rem", "max-w-3xl": "48rem", "max-w-4xl": "56rem", "max-w-5xl": "64rem"
    };
    const twFontSizeMap: Record<string, string> = {
      "text-lg": "1.125rem", "text-xl": "1.25rem", "text-2xl": "1.5rem",
      "text-3xl": "1.875rem", "text-4xl": "2.25rem", "text-5xl": "3rem", "text-6xl": "3.75rem"
    };
    const twProseMap: Record<string, string> = {
      "prose-base": "1rem", "prose-lg": "1.125rem", "prose-xl": "1.25rem"
    };
    const twHeightMap: Record<string, string> = {
      "h-12": "3rem", "h-16": "4rem", "h-20": "5rem", "h-24": "6rem", "h-32": "8rem"
    };
    const twRadiusMap: Record<string, string> = {
      "rounded-none": "0", "rounded-lg": "0.5rem", "rounded-xl": "0.75rem",
      "rounded-2xl": "1rem", "rounded-3xl": "1.5rem", "rounded-full": "9999px"
    };
    const twShadowMap: Record<string, string> = {
      "none": "none", "shadow-sm": "0 1px 2px rgba(0,0,0,0.05)",
      "shadow-md": "0 4px 6px -1px rgba(0,0,0,0.1)", "shadow-lg": "0 10px 15px -3px rgba(0,0,0,0.1)"
    };
    const twTextAlignMap: Record<string, string> = {
      "text-left": "left", "text-center": "center", "text-justify": "justify"
    };

    function formatDate(dateStr: string) {
      return new Date(dateStr).toLocaleDateString("fr-FR", {
        year: "numeric", month: "long", day: "numeric"
      });
    }

    // ── Generate full preview HTML ──
    function generatePreviewHTML(cfg: ReturnType<typeof gatherConfig>) {
      const g = cfg.global;
      const fontsParam = encodeURIComponent(g.headingFont) + ":wght@400;500;600;700&family=" + encodeURIComponent(g.bodyFont) + ":wght@400;500;600;700";

      // Header section
      let headerHTML = "";
      if (cfg.header.visible) {
        headerHTML = `
        <header style="position:fixed;top:0;left:0;right:0;z-index:50;background:${cfg.header.scrollBgColor};backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,0.05);transition:background 0.3s;">
          <nav style="max-width:72rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;">
            <a href="#" style="font-size:1.25rem;font-weight:700;color:${cfg.header.nameColor};text-decoration:none;font-family:'${g.headingFont}',sans-serif;">${mockCompany.nom}</a>
            <div style="display:flex;align-items:center;gap:2rem;">
              <a href="#" style="color:${cfg.header.linkColor};text-decoration:none;font-size:0.875rem;font-weight:500;transition:color 0.2s;"
                 onmouseover="this.style.color='${cfg.header.linkHoverColor}'"
                 onmouseout="this.style.color='${cfg.header.linkColor}'"
              >Accueil</a>
              <a href="#" style="color:${cfg.header.linkColor};text-decoration:none;font-size:0.875rem;font-weight:500;transition:color 0.2s;"
                 onmouseover="this.style.color='${cfg.header.linkHoverColor}'"
                 onmouseout="this.style.color='${cfg.header.linkColor}'"
              >Blog</a>
              <a href="#" style="color:${cfg.header.linkColor};text-decoration:none;font-size:0.875rem;font-weight:500;transition:color 0.2s;"
                 onmouseover="this.style.color='${cfg.header.linkHoverColor}'"
                 onmouseout="this.style.color='${cfg.header.linkColor}'"
              >Contact</a>
            </div>
          </nav>
        </header>`;
      }

      // Hero section
      let heroHTML = "";
      if (cfg.hero.visible) {
        const h = cfg.hero;
        const padY = twPaddingMap[h.verticalPadding] || "6rem";
        const titleSize = twFontSizeMap[h.titleFontSize] || "2.25rem";
        const sloganSize = twFontSizeMap[h.sloganFontSize] || "1.25rem";
        const logoH = twHeightMap[h.logoHeight] || "5rem";
        const logoR = twRadiusMap[h.logoRadius] || "1rem";
        const overlayAlpha = (h.overlayOpacity / 100).toFixed(2);

        const logoHTML = h.showLogo ? `
          <div style="width:${logoH};height:${logoH};border-radius:${logoR};background:rgba(255,255,255,${(h.logoBgOpacity / 100).toFixed(2)});display:flex;align-items:center;justify-content:center;margin-bottom:1.5rem;font-size:2rem;font-weight:700;color:white;font-family:'${g.headingFont}',sans-serif;">
            ${mockCompany.nom.charAt(0)}
          </div>` : "";

        const sloganHTML = h.showSlogan ? `
          <p style="font-size:${sloganSize};color:${h.sloganColor};max-width:36rem;font-family:'${g.bodyFont}',sans-serif;">
            ${mockCompany.slogan}
          </p>` : "";

        heroHTML = `
        <section style="position:relative;min-height:${h.minHeight};display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, ${h.fallbackGradientFrom}, ${h.fallbackGradientTo});overflow:hidden;">
          <div style="position:absolute;inset:0;background:${h.overlayColor};opacity:${overlayAlpha};"></div>
          <div style="position:relative;z-index:1;text-align:center;padding:${padY} 1.5rem;max-width:72rem;margin:0 auto;">
            <div style="display:flex;flex-direction:column;align-items:center;">
              ${logoHTML}
              <h1 style="font-size:${titleSize};font-weight:700;color:${h.titleColor};margin-bottom:1rem;font-family:'${g.headingFont}',sans-serif;line-height:1.2;">
                ${mockCompany.nom}
              </h1>
              ${sloganHTML}
            </div>
          </div>
        </section>`;
      }

      // Description section
      let descHTML = "";
      if (cfg.description.visible) {
        const d = cfg.description;
        const padY = twPaddingMap[d.verticalPadding] || "5rem";
        const maxW = twMaxWidthMap[d.maxWidth] || "48rem";
        const fontSize = twProseMap[d.fontSize] || "1.125rem";
        const textAlign = twTextAlignMap[d.textAlign] || "left";

        descHTML = `
        <section style="background:${d.bgColor};padding:${padY} 1.5rem;">
          <div style="max-width:${maxW};margin:0 auto;text-align:${textAlign};">
            <p style="color:${d.textColor};font-size:${fontSize};line-height:1.8;font-family:'${g.bodyFont}',sans-serif;">
              ${mockCompany.description}
            </p>
          </div>
        </section>`;
      }

      // Blog preview section
      let blogHTML = "";
      if (cfg.blogPreview.visible) {
        const b = cfg.blogPreview;
        const padY = twPaddingMap[b.verticalPadding] || "6rem";
        const cardR = twRadiusMap[b.cardRadius] || "1rem";
        const cardS = twShadowMap[b.cardShadow] || "none";
        const visiblePosts = mockPosts.slice(0, b.postCount);
        const cols = b.postCount <= 2 ? 2 : (b.postCount === 4 ? 2 : 3);

        const cardsHTML = visiblePosts.map(post => `
          <article style="background:white;border-radius:${cardR};overflow:hidden;box-shadow:${cardS};border:1px solid rgba(0,0,0,0.05);transition:transform 0.2s,box-shadow 0.2s;">
            ${b.showCoverImage ? `<img src="${post.coverImage}" alt="${post.title}" style="width:100%;height:200px;object-fit:cover;" loading="lazy" />` : ""}
            <div style="padding:1.5rem;">
              <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                ${b.showCategory ? `<span style="font-size:0.75rem;font-weight:500;color:${g.accentColor};background:${g.accentColor}12;padding:0.25rem 0.625rem;border-radius:9999px;">${post.category}</span>` : ""}
                ${b.showDate ? `<time style="font-size:0.75rem;color:#9ca3af;">${formatDate(post.date)}</time>` : ""}
              </div>
              <h3 style="font-size:1.125rem;font-weight:600;color:#111827;margin-bottom:0.5rem;line-height:1.4;font-family:'${g.headingFont}',sans-serif;">${post.title}</h3>
              ${b.showExcerpt ? `<p style="color:#6b7280;font-size:0.875rem;line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-family:'${g.bodyFont}',sans-serif;">${post.excerpt}</p>` : ""}
            </div>
          </article>
        `).join("");

        blogHTML = `
        <section style="background:${b.bgColor};padding:${padY} 1.5rem;">
          <div style="max-width:72rem;margin:0 auto;">
            <div style="text-align:center;margin-bottom:3rem;">
              ${b.badgeText ? `<span style="display:inline-block;font-size:0.75rem;font-weight:600;color:${g.accentColor};background:${g.accentColor}12;padding:0.375rem 1rem;border-radius:9999px;margin-bottom:1rem;letter-spacing:0.05em;text-transform:uppercase;">${b.badgeText}</span>` : ""}
              ${b.sectionTitle ? `<h2 style="font-size:2rem;font-weight:700;color:#111827;margin-bottom:0.75rem;font-family:'${g.headingFont}',sans-serif;">${b.sectionTitle}</h2>` : ""}
              ${b.sectionSubtitle ? `<p style="font-size:1.125rem;color:#6b7280;max-width:36rem;margin:0 auto;font-family:'${g.bodyFont}',sans-serif;">${b.sectionSubtitle}</p>` : ""}
            </div>
            <div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:2rem;">
              ${cardsHTML}
            </div>
            ${b.ctaText ? `
              <div style="text-align:center;margin-top:3rem;">
                <a href="#" style="display:inline-flex;align-items:center;gap:0.5rem;background:${g.accentColor};color:white;padding:0.75rem 2rem;border-radius:0.5rem;font-weight:600;font-size:0.9375rem;text-decoration:none;font-family:'${g.bodyFont}',sans-serif;transition:opacity 0.2s;">${b.ctaText} &rarr;</a>
              </div>` : ""}
          </div>
        </section>`;
      }

      // Contact section
      let contactHTML = "";
      if (cfg.contact.visible) {
        const c = cfg.contact;
        const padY = twPaddingMap[c.verticalPadding] || "5rem";
        const cardR = twRadiusMap[c.cardRadius] || "1rem";

        contactHTML = `
        <section style="background:${c.bgColor};padding:${padY} 1.5rem;">
          <div style="max-width:72rem;margin:0 auto;">
            <h2 style="font-size:2rem;font-weight:700;color:${c.headingColor};margin-bottom:2.5rem;text-align:center;font-family:'${g.headingFont}',sans-serif;">${c.headingText || "Contact"}</h2>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;max-width:56rem;margin:0 auto;">
              <!-- Email card -->
              <div style="background:${c.cardBgColor};border-radius:${cardR};padding:2rem;text-align:center;">
                <div style="width:3rem;height:3rem;background:${c.iconBgColor};border-radius:0.75rem;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${c.iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                </div>
                <p style="font-size:0.875rem;font-weight:500;color:#6b7280;margin-bottom:0.5rem;font-family:'${g.bodyFont}',sans-serif;">Email</p>
                <a href="#" style="color:${c.linkColor};font-size:0.9375rem;font-weight:500;text-decoration:none;font-family:'${g.bodyFont}',sans-serif;">${mockCompany.email}</a>
              </div>
              <!-- Phone card -->
              <div style="background:${c.cardBgColor};border-radius:${cardR};padding:2rem;text-align:center;">
                <div style="width:3rem;height:3rem;background:${c.iconBgColor};border-radius:0.75rem;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${c.iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                </div>
                <p style="font-size:0.875rem;font-weight:500;color:#6b7280;margin-bottom:0.5rem;font-family:'${g.bodyFont}',sans-serif;">Telephone</p>
                <a href="#" style="color:${c.linkColor};font-size:0.9375rem;font-weight:500;text-decoration:none;font-family:'${g.bodyFont}',sans-serif;">${mockCompany.telephone}</a>
              </div>
              <!-- Address card -->
              <div style="background:${c.cardBgColor};border-radius:${cardR};padding:2rem;text-align:center;">
                <div style="width:3rem;height:3rem;background:${c.iconBgColor};border-radius:0.75rem;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${c.iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                </div>
                <p style="font-size:0.875rem;font-weight:500;color:#6b7280;margin-bottom:0.5rem;font-family:'${g.bodyFont}',sans-serif;">Adresse</p>
                <p style="color:#374151;font-size:0.9375rem;font-family:'${g.bodyFont}',sans-serif;">${mockCompany.adresse}</p>
              </div>
            </div>
          </div>
        </section>`;
      }

      // Footer section
      let footerHTML = "";
      if (cfg.footer.visible) {
        const f = cfg.footer;
        footerHTML = `
        <footer style="background:${f.bgColor};padding:3rem 1.5rem 2rem;">
          <div style="max-width:72rem;margin:0 auto;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem;flex-wrap:wrap;gap:1rem;">
              <span style="font-size:1.125rem;font-weight:700;color:${f.textColor};font-family:'${g.headingFont}',sans-serif;">${mockCompany.nom}</span>
              <div style="display:flex;gap:1.5rem;">
                <a href="#" style="color:${f.linkColor};text-decoration:none;font-size:0.875rem;font-family:'${g.bodyFont}',sans-serif;">Accueil</a>
                <a href="#" style="color:${f.linkColor};text-decoration:none;font-size:0.875rem;font-family:'${g.bodyFont}',sans-serif;">Blog</a>
                <a href="#" style="color:${f.linkColor};text-decoration:none;font-size:0.875rem;font-family:'${g.bodyFont}',sans-serif;">Contact</a>
              </div>
            </div>
            <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:1.5rem;">
              <p style="font-size:0.8125rem;color:${f.copyrightColor};font-family:'${g.bodyFont}',sans-serif;">&copy; ${new Date().getFullYear()} ${mockCompany.nom}. Tous droits reserves.</p>
            </div>
          </div>
        </footer>`;
      }

      const headerTopPad = cfg.header.visible ? "padding-top:4rem;" : "";

      return `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=${fontsParam}&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'${g.bodyFont}',sans-serif;background:${g.pageBgColor};color:#111827;-webkit-font-smoothing:antialiased;${headerTopPad}}
img{display:block;}
a{text-decoration:none;}
@media(max-width:768px){
  .grid-3{grid-template-columns:1fr !important;}
  .grid-2{grid-template-columns:1fr !important;}
}
</style>
</head>
<body>
${headerHTML}
${heroHTML}
${descHTML}
${blogHTML}
${contactHTML}
${footerHTML}
</body>
</html>`;
    }

    // ── Preview update with debounce ──
    function updatePreview() {
      const cfg = gatherConfig();
      const iframe = document.getElementById("landingPreview") as HTMLIFrameElement;
      if (iframe) {
        iframe.srcdoc = generatePreviewHTML(cfg);
      }
    }

    function schedulePreviewUpdate(delay = 150) {
      if (previewUpdateTimer) clearTimeout(previewUpdateTimer);
      previewUpdateTimer = setTimeout(updatePreview, delay);
    }

    // ── Accordion ──
    function setupAccordions() {
      document.querySelectorAll<HTMLElement>(".accordion-trigger").forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.closest(".accordion-section")!;
          section.classList.toggle("collapsed");
        });
      });
      // Collapse all except first by default
      const sections = document.querySelectorAll<HTMLElement>(".accordion-section");
      sections.forEach((s, i) => {
        if (i > 0) s.classList.add("collapsed");
      });
    }

    // ── Color sync helper ──
    function syncColorPair(pickerId: string, textId: string, onChange?: () => void) {
      const picker = $(pickerId);
      const text = $(textId);
      if (!picker || !text) return;

      picker.addEventListener("input", () => {
        text.value = picker.value;
        if (onChange) onChange();
        schedulePreviewUpdate(100);
      });
      text.addEventListener("input", () => {
        const val = text.value.trim();
        if (/^#[0-9a-fA-F]{6}$/.test(val)) {
          picker.value = val;
        }
        // Allow rgba and other non-hex values in text field
        if (onChange) onChange();
        schedulePreviewUpdate(250);
      });
    }

    // ── Setup all color syncs ──
    function setupColorSyncs() {
      const colorPairs = [
        ["cfg-accentColor", "cfg-accentColorText"],
        ["cfg-pageBgColor", "cfg-pageBgColorText"],
        ["cfg-heroOverlayColor", "cfg-heroOverlayColorText"],
        ["cfg-heroGradientFrom", "cfg-heroGradientFromText"],
        ["cfg-heroGradientTo", "cfg-heroGradientToText"],
        ["cfg-heroTitleColor", "cfg-heroTitleColorText"],
        ["cfg-heroSloganColor", "cfg-heroSloganColorText"],
        ["cfg-descTextColor", "cfg-descTextColorText"],
        ["cfg-descBgColor", "cfg-descBgColorText"],
        ["cfg-blogBgColor", "cfg-blogBgColorText"],
        ["cfg-contactHeadingColor", "cfg-contactHeadingColorText"],
        ["cfg-contactBgColor", "cfg-contactBgColorText"],
        ["cfg-contactCardBgColor", "cfg-contactCardBgColorText"],
        ["cfg-contactIconBgColor", "cfg-contactIconBgColorText"],
        ["cfg-contactIconColor", "cfg-contactIconColorText"],
        ["cfg-contactLinkColor", "cfg-contactLinkColorText"],
        ["cfg-headerScrollBgColor", "cfg-headerScrollBgColorText"],
        ["cfg-headerNameColor", "cfg-headerNameColorText"],
        ["cfg-headerLinkColor", "cfg-headerLinkColorText"],
        ["cfg-headerLinkHoverColor", "cfg-headerLinkHoverColorText"],
        ["cfg-footerBgColor", "cfg-footerBgColorText"],
        ["cfg-footerTextColor", "cfg-footerTextColorText"],
        ["cfg-footerLinkColor", "cfg-footerLinkColorText"],
        ["cfg-footerCopyrightColor", "cfg-footerCopyrightColorText"],
      ];
      colorPairs.forEach(([p, t]) => syncColorPair(p, t));
    }

    // ── Range inputs value display ──
    function setupRangeInputs() {
      const ranges = [
        ["cfg-heroOverlayOpacity", "heroOverlayVal"],
        ["cfg-heroLogoBgOpacity", "heroLogoBgOpacityVal"],
      ];
      ranges.forEach(([inputId, labelId]) => {
        const input = $(inputId);
        const label = document.getElementById(labelId);
        if (!input || !label) return;
        input.addEventListener("input", () => {
          label.textContent = input.value;
          schedulePreviewUpdate(50);
        });
      });
    }

    // ── Reactive binding ──
    function setupReactiveInputs() {
      // Text inputs with debounce
      const textInputs = [
        "cfg-blogBadgeText", "cfg-blogSectionTitle", "cfg-blogSectionSubtitle",
        "cfg-blogCtaText", "cfg-contactHeadingText"
      ];
      textInputs.forEach(id => {
        $(id)?.addEventListener("input", () => schedulePreviewUpdate());
      });

      // Selects — immediate
      const selects = [
        "cfg-headingFont", "cfg-bodyFont",
        "cfg-heroMinHeight", "cfg-heroLogoHeight", "cfg-heroLogoRadius",
        "cfg-heroTitleFontSize", "cfg-heroSloganFontSize", "cfg-heroVerticalPadding",
        "cfg-descMaxWidth", "cfg-descFontSize", "cfg-descTextAlign", "cfg-descVerticalPadding",
        "cfg-blogPostCount", "cfg-blogCardRadius", "cfg-blogCardShadow", "cfg-blogVerticalPadding",
        "cfg-contactCardRadius", "cfg-contactVerticalPadding"
      ];
      selects.forEach(id => {
        $(id)?.addEventListener("change", () => schedulePreviewUpdate(0));
      });

      // Toggles — immediate
      const toggles = [
        "cfg-heroVisible", "cfg-heroShowLogo", "cfg-heroShowSlogan",
        "cfg-descVisible",
        "cfg-blogVisible", "cfg-blogShowCoverImage", "cfg-blogShowCategory",
        "cfg-blogShowDate", "cfg-blogShowExcerpt",
        "cfg-contactVisible",
        "cfg-headerVisible",
        "cfg-footerVisible"
      ];
      toggles.forEach(id => {
        $(id)?.addEventListener("change", () => schedulePreviewUpdate(0));
      });
    }

    // ── Device toggle ──
    function setupDeviceToggle() {
      const deviceSizes: Record<string, string> = {
        desktop: "100%",
        tablet: "768px",
        mobile: "375px"
      };
      document.querySelectorAll<HTMLButtonElement>(".device-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".device-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const device = btn.dataset.device || "desktop";
          const iframe = document.getElementById("landingPreview") as HTMLIFrameElement;
          iframe.style.maxWidth = deviceSizes[device];
        });
      });
    }

    // ── Resize handle ──
    function setupResizeHandle() {
      const handle = document.getElementById("resizeHandle")!;
      const controls = document.getElementById("builderControls")!;
      let startX = 0;
      let startWidth = 0;

      function onMouseDown(e: MouseEvent) {
        e.preventDefault();
        startX = e.clientX;
        startWidth = controls.offsetWidth;
        handle.classList.add("dragging");
        document.body.classList.add("resizing");
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      }

      function onMouseMove(e: MouseEvent) {
        const delta = e.clientX - startX;
        const newWidth = Math.min(Math.max(startWidth + delta, 240), window.innerWidth * 0.5);
        controls.style.width = newWidth + "px";
      }

      function onMouseUp() {
        handle.classList.remove("dragging");
        document.body.classList.remove("resizing");
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }

      handle.addEventListener("mousedown", onMouseDown);
    }

    // ── Mobile controls toggle ──
    function setupMobileControls() {
      const controls = document.getElementById("builderControls")!;
      const openBtn = document.getElementById("openControls")!;
      const closeBtn = document.getElementById("closeControls")!;

      openBtn.addEventListener("click", () => {
        controls.classList.add("open");
      });
      closeBtn.addEventListener("click", () => {
        controls.classList.remove("open");
      });
    }

    // ── Populate controls from config ──
    function populateControls(cfg: any) {
      // Global
      const g = cfg.global || {};
      $("cfg-accentColor").value = g.accentColor || "#5700FF";
      $("cfg-accentColorText").value = g.accentColor || "#5700FF";
      $("cfg-pageBgColor").value = g.pageBgColor || "#FAFAF8";
      $("cfg-pageBgColorText").value = g.pageBgColor || "#FAFAF8";
      ($("cfg-headingFont") as HTMLSelectElement).value = g.headingFont || "Plus Jakarta Sans";
      ($("cfg-bodyFont") as HTMLSelectElement).value = g.bodyFont || "Inter";

      // Hero
      const h = cfg.hero || {};
      $("cfg-heroVisible").checked = h.visible ?? true;
      ($("cfg-heroMinHeight") as HTMLSelectElement).value = h.minHeight || "70vh";
      $("cfg-heroOverlayOpacity").value = String(h.overlayOpacity ?? 50);
      document.getElementById("heroOverlayVal")!.textContent = String(h.overlayOpacity ?? 50);
      $("cfg-heroOverlayColor").value = h.overlayColor || "#000000";
      $("cfg-heroOverlayColorText").value = h.overlayColor || "#000000";
      $("cfg-heroGradientFrom").value = h.fallbackGradientFrom || "#5700FF";
      $("cfg-heroGradientFromText").value = h.fallbackGradientFrom || "#5700FF";
      $("cfg-heroGradientTo").value = h.fallbackGradientTo || "#350099";
      $("cfg-heroGradientToText").value = h.fallbackGradientTo || "#350099";
      $("cfg-heroShowLogo").checked = h.showLogo ?? true;
      ($("cfg-heroLogoHeight") as HTMLSelectElement).value = h.logoHeight || "h-20";
      ($("cfg-heroLogoRadius") as HTMLSelectElement).value = h.logoRadius || "rounded-2xl";
      $("cfg-heroLogoBgOpacity").value = String(h.logoBgOpacity ?? 10);
      document.getElementById("heroLogoBgOpacityVal")!.textContent = String(h.logoBgOpacity ?? 10);
      ($("cfg-heroTitleFontSize") as HTMLSelectElement).value = h.titleFontSize || "text-4xl";
      $("cfg-heroTitleColor").value = h.titleColor || "#ffffff";
      $("cfg-heroTitleColorText").value = h.titleColor || "#ffffff";
      $("cfg-heroShowSlogan").checked = h.showSlogan ?? true;
      ($("cfg-heroSloganFontSize") as HTMLSelectElement).value = h.sloganFontSize || "text-xl";
      // Slogan color may be rgba, only set hex picker if it's hex
      const sloganC = h.sloganColor || "rgba(255,255,255,0.9)";
      if (/^#[0-9a-fA-F]{6}$/.test(sloganC)) {
        $("cfg-heroSloganColor").value = sloganC;
      }
      $("cfg-heroSloganColorText").value = sloganC;
      ($("cfg-heroVerticalPadding") as HTMLSelectElement).value = h.verticalPadding || "py-24";

      // Description
      const d = cfg.description || {};
      $("cfg-descVisible").checked = d.visible ?? true;
      ($("cfg-descMaxWidth") as HTMLSelectElement).value = d.maxWidth || "max-w-3xl";
      ($("cfg-descFontSize") as HTMLSelectElement).value = d.fontSize || "prose-lg";
      $("cfg-descTextColor").value = d.textColor || "#4B5563";
      $("cfg-descTextColorText").value = d.textColor || "#4B5563";
      ($("cfg-descTextAlign") as HTMLSelectElement).value = d.textAlign || "text-left";
      $("cfg-descBgColor").value = d.bgColor || "#FAFAF8";
      $("cfg-descBgColorText").value = d.bgColor || "#FAFAF8";
      ($("cfg-descVerticalPadding") as HTMLSelectElement).value = d.verticalPadding || "py-20";

      // Blog Preview
      const b = cfg.blogPreview || {};
      $("cfg-blogVisible").checked = b.visible ?? true;
      $("cfg-blogBadgeText").value = b.badgeText ?? "Blog";
      $("cfg-blogSectionTitle").value = b.sectionTitle ?? "Derniers articles";
      ($("cfg-blogSectionSubtitle") as HTMLTextAreaElement).value = b.sectionSubtitle ?? "Actualites, articles, interviews...";
      $("cfg-blogCtaText").value = b.ctaText ?? "Voir tous les articles";
      ($("cfg-blogPostCount") as HTMLSelectElement).value = String(b.postCount ?? 3);
      $("cfg-blogBgColor").value = b.bgColor || "#F5F3EF";
      $("cfg-blogBgColorText").value = b.bgColor || "#F5F3EF";
      ($("cfg-blogCardRadius") as HTMLSelectElement).value = b.cardRadius || "rounded-2xl";
      ($("cfg-blogCardShadow") as HTMLSelectElement).value = b.cardShadow || "none";
      $("cfg-blogShowCoverImage").checked = b.showCoverImage ?? true;
      $("cfg-blogShowCategory").checked = b.showCategory ?? true;
      $("cfg-blogShowDate").checked = b.showDate ?? true;
      $("cfg-blogShowExcerpt").checked = b.showExcerpt ?? true;
      ($("cfg-blogVerticalPadding") as HTMLSelectElement).value = b.verticalPadding || "py-24";

      // Contact
      const c = cfg.contact || {};
      $("cfg-contactVisible").checked = c.visible ?? true;
      $("cfg-contactHeadingText").value = c.headingText ?? "Contact";
      $("cfg-contactHeadingColor").value = c.headingColor || "#111827";
      $("cfg-contactHeadingColorText").value = c.headingColor || "#111827";
      $("cfg-contactBgColor").value = c.bgColor || "#F5F3EF";
      $("cfg-contactBgColorText").value = c.bgColor || "#F5F3EF";
      ($("cfg-contactCardRadius") as HTMLSelectElement).value = c.cardRadius || "rounded-2xl";
      $("cfg-contactCardBgColor").value = c.cardBgColor || "#ffffff";
      $("cfg-contactCardBgColorText").value = c.cardBgColor || "#ffffff";
      $("cfg-contactIconBgColor").value = c.iconBgColor || "#f3eeff";
      $("cfg-contactIconBgColorText").value = c.iconBgColor || "#f3eeff";
      $("cfg-contactIconColor").value = c.iconColor || "#5700FF";
      $("cfg-contactIconColorText").value = c.iconColor || "#5700FF";
      $("cfg-contactLinkColor").value = c.linkColor || "#5700FF";
      $("cfg-contactLinkColorText").value = c.linkColor || "#5700FF";
      ($("cfg-contactVerticalPadding") as HTMLSelectElement).value = c.verticalPadding || "py-20";

      // Header
      const hd = cfg.header || {};
      $("cfg-headerVisible").checked = hd.visible ?? true;
      const scrollBg = hd.scrollBgColor || "rgba(250,250,248,0.8)";
      if (/^#[0-9a-fA-F]{6}$/.test(scrollBg)) {
        $("cfg-headerScrollBgColor").value = scrollBg;
      }
      $("cfg-headerScrollBgColorText").value = scrollBg;
      $("cfg-headerNameColor").value = hd.nameColor || "#111827";
      $("cfg-headerNameColorText").value = hd.nameColor || "#111827";
      $("cfg-headerLinkColor").value = hd.linkColor || "#4B5563";
      $("cfg-headerLinkColorText").value = hd.linkColor || "#4B5563";
      $("cfg-headerLinkHoverColor").value = hd.linkHoverColor || "#111827";
      $("cfg-headerLinkHoverColorText").value = hd.linkHoverColor || "#111827";

      // Footer
      const f = cfg.footer || {};
      $("cfg-footerVisible").checked = f.visible ?? true;
      $("cfg-footerBgColor").value = f.bgColor || "#5700FF";
      $("cfg-footerBgColorText").value = f.bgColor || "#5700FF";
      $("cfg-footerTextColor").value = f.textColor || "#ffffff";
      $("cfg-footerTextColorText").value = f.textColor || "#ffffff";
      const linkC = f.linkColor || "rgba(255,255,255,0.6)";
      if (/^#[0-9a-fA-F]{6}$/.test(linkC)) {
        $("cfg-footerLinkColor").value = linkC;
      }
      $("cfg-footerLinkColorText").value = linkC;
      const copyrightC = f.copyrightColor || "rgba(255,255,255,0.4)";
      if (/^#[0-9a-fA-F]{6}$/.test(copyrightC)) {
        $("cfg-footerCopyrightColor").value = copyrightC;
      }
      $("cfg-footerCopyrightColorText").value = copyrightC;
    }

    // ── Load config ──
    async function loadConfig() {
      try {
        const res = await fetch("/api/admin/landing-config");
        if (res.status === 401) { window.location.href = "/admin/login"; return; }
        const data = await res.json();

        const cfg = data.config || {};
        populateControls(cfg);

        setupColorSyncs();
        setupRangeInputs();
        setupReactiveInputs();
        setupDeviceToggle();
        setupMobileControls();
        setupResizeHandle();
        setupAccordions();

        updatePreview();

        document.getElementById("loadingOverlay")!.classList.add("hidden");
      } catch {
        showMessage("Erreur de chargement", "error");
        document.getElementById("loadingOverlay")!.classList.add("hidden");
      }
    }

    // ── Save & Deploy ──
    document.getElementById("saveBtn")!.addEventListener("click", async () => {
      const btn = document.getElementById("saveBtn") as HTMLButtonElement;
      const status = document.getElementById("saveStatus")!;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Publication...';
      status.textContent = "Sauvegarde en cours...";

      try {
        const config = gatherConfig();

        const res = await fetch("/api/admin/landing-config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ config }),
        });

        if (res.status === 401) { window.location.href = "/admin/login"; return; }

        const data = await res.json();
        if (data.success) {
          showMessage(data.message || "Configuration sauvegardee !", "success");
          status.textContent = "Publie avec succes";
        } else {
          showMessage(data.error || "Erreur lors de la sauvegarde", "error");
          status.textContent = "Erreur de publication";
        }
      } catch {
        showMessage("Erreur reseau", "error");
        status.textContent = "Erreur reseau";
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Enregistrer & Publier';
        setTimeout(() => { status.textContent = "Pret a publier"; }, 4000);
      }
    });

    // Init
    loadConfig();
  </script>
</Admin>
